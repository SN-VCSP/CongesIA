<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONG√âS - Assistant IA pour vos Cong√©s</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Couleurs Vinci/Eurovia */
            --vinci-blue: #003366e3;
            --vinci-blue-dark: #001F3F;
            --vinci-blue-light: #004080;
            --vinci-red: #E30613;
            --vinci-red-dark: #C10510;
            --vinci-orange: #f7622c;
            --vinci-white: #FFFFFF;
            --vinci-gray: #F5F5F5;
            --vinci-gray-dark: #666666;
            --vinci-gray-light: #e0e0e0da;

            /* Application des couleurs */
            --primary: var(--vinci-blue);
            --primary-dark: var(--vinci-blue-dark);
            --secondary: var(--vinci-red);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: var(--vinci-red);
            --bg: var(--vinci-gray);
            --card: var(--vinci-white);
            --text: var(--vinci-blue-dark);
            --text-light: var(--vinci-gray-dark);
            --border: var(--vinci-gray-light);
            --gradient-1: linear-gradient(135deg, var(--vinci-blue) 0%, var(--vinci-blue-dark) 100%);
            --gradient-2: linear-gradient(135deg, var(--vinci-red) 0%, var(--vinci-red-dark) 100%);
            --gradient-3: linear-gradient(135deg, var(--vinci-blue-light) 0%, var(--vinci-blue) 100%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--gradient-1);
            color: white;
            padding: 30px 20px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 51, 102, 0.3);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: var(--vinci-red);
            border-radius: 50%;
            opacity: 0.1;
            transform: translate(30%, -30%);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 30px;
            position: relative;
            z-index: 1;
        }

        .logo-container {
            flex-shrink: 0;
        }

        .logo-eurovia {
            max-height: 80px;
            max-width: 200px;
            height: auto;
            width: auto;
            filter: brightness(0) invert(1);
        }

        .header-text {
            flex: 1;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            color: var(--vinci-white);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .ai-agent {
            background: var(--card);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--vinci-blue);
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .ai-avatar {
            width: 60px;
            height: 60px;
            background: var(--gradient-2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 10px rgba(227, 6, 19, 0.3);
        }

        /* Animation for dynamic inputs */
        #ouvrierInputs,
        #etamInputs {
            animation: fadeIn 0.4s ease-out;
        }

        .ai-message {
            background: var(--bg);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid var(--vinci-blue);
            animation: slideIn 0.3s ease;
            line-height: 1.6;
        }

        .ai-suggestion {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid var(--vinci-blue);
            padding: 15px;
            border-radius: 8px;
            margin-top: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-suggestion:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 51, 102, 0.15);
        }

        .ai-suggestion-title {
            font-weight: bold;
            color: var(--vinci-blue);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-suggestion-desc {
            color: var(--text);
            font-size: 0.95rem;
        }

        .planning-helper {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .planning-helper h4 {
            color: var(--vinci-blue);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .planning-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .suggestion-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .suggestion-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--vinci-blue);
        }

        .suggestion-card-title {
            font-weight: bold;
            color: var(--vinci-blue);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .suggestion-card-desc {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .suggestion-card-action {
            display: inline-block;
            padding: 6px 12px;
            background: var(--gradient-1);
            color: white;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .suggestion-card-action:hover {
            transform: scale(1.05);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: var(--vinci-blue);
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .balance-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .balance-item {
            background: var(--bg);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .balance-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--vinci-blue);
        }

        .balance-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--vinci-blue);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-1);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 51, 102, 0.3);
        }

        .btn-secondary {
            background: var(--gradient-3);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #b91c1c);
            color: white;
        }

        .simulation-result {
            background: var(--bg);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .gain-loss {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .gain,
        .loss {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .gain {
            background: linear-gradient(135deg, #d1fae515 0%, #6ee7b715 100%);
            border: 2px solid var(--success);
        }

        .loss {
            background: linear-gradient(135deg, #fee2e215 0%, #fecaca15 100%);
            border: 2px solid var(--danger);
        }

        .gain-label,
        .loss-label {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: var(--text-light);
        }

        .gain-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--success);
        }

        .loss-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--danger);
        }

        .history-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .table-container {
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            margin-top: 20px;
        }

        .table-container table {
            min-width: 600px;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .history-table th {
            background: var(--bg);
            color: var(--vinci-blue);
            font-weight: 600;
        }

        .history-table tr:hover {
            background: var(--bg);
        }

        .history-table .btn {
            font-size: 0.85rem;
            padding: 6px 12px;
            white-space: nowrap;
        }

        .audit-alert {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .audit-alert.success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--success);
            color: #065f46;
        }

        .audit-alert.warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
            color: #92400e;
        }

        .audit-alert.error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--danger);
            color: #991b1b;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--vinci-blue) var(--bg);
        }

        .tabs::-webkit-scrollbar {
            height: 6px;
        }

        .tabs::-webkit-scrollbar-track {
            background: var(--bg);
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--vinci-blue);
            border-radius: 3px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--vinci-blue);
            border-bottom-color: var(--vinci-blue);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* CALENDRIER INTERACTIF */
        .calendar-container {
            grid-column: 1 / -1;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: var(--gradient-1);
            border-radius: 12px;
            color: white;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 1rem;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .current-month {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .day-header {
            text-align: center;
            font-weight: bold;
            padding: 8px 4px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 8px;
            color: var(--vinci-blue);
            font-size: 0.75rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            min-height: 35px;
        }

        .calendar-day:hover {
            transform: scale(1.08);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            border-color: var(--vinci-blue);
        }

        .calendar-day.other-month {
            opacity: 0.25;
        }

        .calendar-day.weekend {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        .calendar-day.holiday {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }

        .calendar-day.too-early {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px dashed #f59e0b;
            opacity: 0.7;
            position: relative;
        }

        .calendar-day.too-early::after {
            content: '‚ö†Ô∏è';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
        }

        .calendar-day.past-date {
            background: #e5e7eb;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, var(--vinci-blue), var(--vinci-blue-light));
            color: white;
            border-color: var(--vinci-red);
            font-weight: bold;
        }

        .calendar-day.range-start,
        .calendar-day.range-end {
            background: linear-gradient(135deg, var(--vinci-red), var(--vinci-orange));
            color: white;
            font-weight: bold;
        }

        .calendar-day.in-range {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: var(--vinci-blue);
        }

        .calendar-day.suggested {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid var(--warning);
            position: relative;
        }

        .calendar-day.suggested::after {
            content: 'üí°';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
        }

        .calendar-day.suggested-start,
        .calendar-day.suggested-end {
            background: linear-gradient(135deg, var(--warning), #f59e0b);
            color: white;
            font-weight: bold;
            border: 2px solid var(--vinci-blue);
        }

        .day-number {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .day-indicator {
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--vinci-red);
        }

        .selection-info {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 2px solid var(--warning);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .selection-header {
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--vinci-blue);
        }

        .periods-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        .period-item {
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .period-item:hover {
            border-color: var(--vinci-blue);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .period-info {
            flex: 1;
        }

        .period-dates {
            font-size: 1rem;
            font-weight: bold;
            color: var(--vinci-blue);
            margin-bottom: 5px;
        }

        .period-days {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .period-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .selection-summary {
            background: var(--bg);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
        }

        .selection-total {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--vinci-red);
            margin-top: 8px;
        }

        /* Optimisations IA */
        .optimization-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid var(--success);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .optimization-card:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        .optimization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .optimization-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--vinci-blue);
        }

        .optimization-badge {
            background: var(--success);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .optimization-details {
            color: var(--text);
            margin-bottom: 10px;
        }

        .optimization-gain {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-top: 15px;
        }

        .gain-item {
            flex: 1;
            text-align: center;
        }

        .tip-box {
            background: linear-gradient(135deg, #fef3c715 0%, #fde68a15 100%);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid var(--warning);
        }

        .tip-box strong {
            color: var(--warning);
        }

        .analysis-box {
            background: var(--bg);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid var(--vinci-blue);
        }

        .analysis-box h4 {
            color: var(--vinci-blue);
            margin-bottom: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 51, 102, 0.3);
            border-radius: 50%;
            border-top-color: var(--vinci-blue);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .logo-container {
                margin-bottom: 15px;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .balance-display {
                grid-template-columns: repeat(2, 1fr);
            }

            .gain-loss {
                grid-template-columns: 1fr;
            }

            .calendar-grid {
                gap: 5px;
            }

            .day-number {
                font-size: 0.8rem;
            }

            .calendar-day {
                min-height: 30px;
            }

            .planning-suggestions {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }

            .calendar-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 10px;
                margin: -10px;
            }

            .calendar-grid {
                min-width: 700px;
                gap: 3px;
            }

            .calendar-day {
                min-height: 35px;
                font-size: 0.75rem;
                padding: 2px;
            }

            .day-number {
                font-size: 0.7rem;
            }

            .day-label {
                font-size: 0.65rem;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: -15px;
                padding: 15px;
            }

            .periods-list {
                max-height: 300px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .selection-info {
                max-height: 400px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tabs {
                padding-bottom: 5px;
            }

            .tab {
                padding: 10px 16px;
                font-size: 0.9rem;
                white-space: nowrap;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <img src="logo-eurovia.png" alt="Logo Eurovia" class="logo-eurovia"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display: none; color: white; font-weight: bold; font-size: 1.5rem;">EUROVIA</div>
                </div>
                <div class="header-text">
                    <h1>üéâ CONG√âS</h1>
                    <p>Votre assistant IA intelligent pour optimiser vos cong√©s CNETP</p>
                </div>
                <div style="position: absolute; top: 15px; right: 15px; font-size: 0.9rem; opacity: 0.9; z-index: 2;">
                    <span id="saveIndicator"
                        style="display: none; background: rgba(255,255,255,0.3); padding: 5px 10px; border-radius: 5px;">üíæ
                        Sauvegard√©</span>
                </div>
            </div>
        </header>

        <div class="ai-agent">
            <div class="ai-header">
                <div class="ai-avatar">ü§ñ</div>
                <div>
                    <h3>Assistant IA</h3>
                    <p style="color: var(--text-light); font-size: 0.9rem;">Pr√™t √† vous aider √† optimiser vos cong√©s</p>
                </div>
            </div>
            <div id="aiMessage" class="ai-message">
                <strong>üëã Bonjour !</strong> Je suis votre assistant IA pour optimiser vos cong√©s CNETP sur toute
                l'ann√©e.<br><br>
                <div
                    style="background: rgba(251, 191, 36, 0.1); border-left: 4px solid #f59e0b; padding: 10px; margin: 10px 0; border-radius: 5px;">
                    <strong>‚ö†Ô∏è R√®gles entreprise (courrier 2 avril 2025) :</strong><br>
                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                        <li>Vous devez poser vos cong√©s <strong>au moins 1 mois (30 jours) avant votre date de
                                d√©part</strong></li>
                        <li><strong>Les demi-journ√©es de cong√©s pay√©s ne sont plus autoris√©es</strong> - seuls les jours
                            entiers sont accept√©s</li>
                    </ul>
                </div>
                <div
                    style="background: rgba(0, 51, 102, 0.1); border-left: 4px solid var(--vinci-blue); padding: 10px; margin: 10px 0; border-radius: 5px;">
                    <strong>‚ÑπÔ∏è Gestion & Paiement CNETP :</strong><br>
                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                        <li>Les cong√©s sont g√©r√©s et <strong>pay√©s directement par la CNETP</strong>, pas par
                            l'entreprise.</li>
                        <li><strong>Attention au d√©calage :</strong> L'indemnit√© de cong√©s est vers√©e ind√©pendamment du
                            salaire, ce qui peut entra√Æner un d√©calage de tr√©sorerie.</li>
                    </ul>
                </div>
                <strong>üí° Comment je peux vous aider :</strong>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li><strong>Planification annuelle</strong> : Je vous sugg√®re les meilleures p√©riodes pour vos
                        vacances</li>
                    <li><strong>Optimisation intelligente</strong> : Je trouve les ponts et optimise vos dates pour
                        maximiser vos jours de repos</li>
                    <li><strong>Conseils personnalis√©s</strong> : Je vous guide pour obtenir le fractionnement et
                        optimiser votre solde</li>
                    <li><strong>Vue d'ensemble</strong> : Je vous aide √† visualiser et planifier toute votre ann√©e</li>
                </ul>
                <div id="aiSuggestions"></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('calendar')">üìÖ Calendrier</button>
            <button class="tab" onclick="switchTab('balance')">üìä Mon Solde</button>
            <button class="tab" onclick="switchTab('simulate')">üéØ Simulation</button>
            <button class="tab" onclick="switchTab('history')">üìã Historique</button>
            <button class="tab" onclick="switchTab('audit')">üîç Audit</button>
        </div>

        <!-- Tab: Calendrier Interactif -->
        <div id="calendarTab" class="tab-content active">
            <div class="grid">
                <div class="card calendar-container">
                    <h3><span class="card-icon">üìÖ</span> Calendrier Interactif</h3>

                    <div class="calendar-header">
                        <button class="nav-btn" onclick="previousMonth()">‚óÄ</button>
                        <div class="current-month" id="currentMonth">Janvier 2025</div>
                        <button class="nav-btn" onclick="nextMonth()">‚ñ∂</button>
                    </div>

                    <div id="selectionInfo" class="selection-info" style="display: none;">
                        <div class="selection-header">üìç P√©riodes s√©lectionn√©es</div>
                        <div id="periodsList" class="periods-list"></div>
                        <div class="selection-summary">
                            <div style="font-size: 0.9rem; color: var(--text-light);">Total de jours ouvrables</div>
                            <div class="selection-total" id="selectionTotal">0 jours</div>
                        </div>
                        <div
                            style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="confirmAllSelections()">‚úì Valider toutes les
                                p√©riodes</button>
                            <button class="btn btn-warning" onclick="clearAllSelections()">üóëÔ∏è Effacer toutes les
                                s√©lections</button>
                        </div>
                    </div>

                    <div class="calendar-grid" id="calendarGrid"></div>

                    <div
                        style="margin-top: 20px; padding: 15px; background: var(--bg); border-radius: 10px; border-left: 4px solid var(--vinci-blue);">
                        <div style="font-weight: bold; color: var(--vinci-blue); margin-bottom: 8px;">üí° Comment
                            planifier plusieurs p√©riodes :</div>
                        <div style="font-size: 0.9rem; color: var(--text-light); line-height: 1.6;">
                            1. Cliquez sur une date de d√©but<br>
                            2. Cliquez sur une date de fin pour cr√©er une p√©riode<br>
                            3. R√©p√©tez pour ajouter d'autres p√©riodes<br>
                            4. Validez toutes les p√©riodes en une fois ou individuellement
                        </div>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="optimizeSelection()">üéØ Optimiser la p√©riode</button>
                        <button class="btn btn-warning" onclick="clearSelection()">üóëÔ∏è Effacer s√©lection en
                            cours</button>
                        <button class="btn btn-secondary" onclick="clearSuggestions()" id="clearSuggestionsBtn"
                            style="display: none;">üóëÔ∏è Effacer suggestions</button>
                    </div>
                    <div id="suggestionsInfo"
                        style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border-left: 4px solid var(--warning); display: none;">
                        <div style="font-weight: bold; color: var(--vinci-blue); margin-bottom: 5px;">üí° P√©riodes
                            sugg√©r√©es affich√©es</div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">
                            Les p√©riodes en <strong>jaune/orange</strong> sont des suggestions de l'IA. Cliquez
                            directement sur une p√©riode sugg√©r√©e pour l'ajouter √† votre planning.
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3><span class="card-icon">üéÅ</span> Optimisations IA</h3>
                    <div id="optimizations">
                        <p style="color: var(--text-light); text-align: center; padding: 40px;">
                            S√©lectionnez une p√©riode sur le calendrier pour voir les optimisations possibles
                        </p>
                    </div>
                </div>

                <div class="card planning-helper">
                    <h4><span class="card-icon">üìÖ</span> Planification Annuelle - Conseils IA</h4>
                    <p style="color: var(--text-light); margin-bottom: 15px; font-size: 0.95rem;">
                        Laissez-moi vous aider √† planifier vos vacances sur toute l'ann√©e pour optimiser votre solde et
                        profiter au maximum.
                    </p>
                    <div id="planningSuggestions" class="planning-suggestions">
                        <div class="suggestion-card">
                            <div class="suggestion-card-title">üåâ Optimiser les ponts</div>
                            <div class="suggestion-card-desc">Je peux identifier les meilleurs ponts de l'ann√©e pour
                                maximiser vos jours de repos</div>
                            <button class="suggestion-card-action" onclick="suggestBridges()">Voir les ponts</button>
                        </div>
                        <div class="suggestion-card">
                            <div class="suggestion-card-title">‚òÄÔ∏è P√©riode estivale</div>
                            <div class="suggestion-card-desc">Planifiez 12 jours continus en √©t√© pour obtenir le
                                fractionnement</div>
                            <button class="suggestion-card-action" onclick="suggestSummerPeriod()">Sugg√©rer une
                                p√©riode</button>
                        </div>
                        <div class="suggestion-card">
                            <div class="suggestion-card-title">‚ùÑÔ∏è P√©riode hivernale</div>
                            <div class="suggestion-card-desc">R√©servez 3-6 jours du principal en hiver pour maximiser le
                                fractionnement</div>
                            <button class="suggestion-card-action" onclick="suggestWinterPeriod()">Sugg√©rer une
                                p√©riode</button>
                        </div>
                        <div class="suggestion-card">
                            <div class="suggestion-card-title">üìä Analyse compl√®te</div>
                            <div class="suggestion-card-desc">J'analyse votre situation et vous propose un plan
                                d'optimisation personnalis√©</div>
                            <button class="suggestion-card-action" onclick="generateYearlyPlan()">G√©n√©rer un
                                plan</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Balance -->
        <div id="balanceTab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3><span class="card-icon">‚öôÔ∏è</span> Configuration</h3>
                    <div class="form-group">
                        <label>Droits annuels acquis (jours ouvrables)</label>
                        <input type="number" id="annualRights" value="30" min="0" step="1"
                            onchange="calculateBalance(); autoSave();">
                    </div>
                    <div class="form-group">
                        <label>Cat√©gorie Professionnelle</label>
                        <select id="userCategory" onchange="toggleSeniorityInputs(); calculateBalance(); autoSave();">
                            <option value="ouvrier">Ouvrier</option>
                            <option value="etam">ETAM / Cadre</option>
                        </select>
                    </div>

                    <div id="ouvrierInputs">
                        <div class="form-group">
                            <label>Ann√©es de service (Ouvrier)</label>
                            <input type="number" id="serviceYears" value="0" min="0" step="1"
                                onchange="calculateBalance(); autoSave();">
                        </div>
                    </div>

                    <div id="etamInputs" style="display: none;">
                        <div class="form-group">
                            <label>Anciennet√© Entreprise (ann√©es)</label>
                            <input type="number" id="companySeniority" value="0" min="0" step="1"
                                onchange="calculateBalance(); autoSave();">
                        </div>
                        <div class="form-group">
                            <label>Anciennet√© Profession (ann√©es)</label>
                            <input type="number" id="professionSeniority" value="0" min="0" step="1"
                                onchange="calculateBalance(); autoSave();">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>CP Anciennet√© (Calcul√© automatiquement)</label>
                        <input type="number" id="anciennete" value="0" min="0" step="1" readonly
                            style="background: var(--bg);">
                    </div>
                    <div class="form-group">
                        <label>CP Enfant √† charge</label>
                        <input type="number" id="enfant" value="0" min="0" step="1"
                            onchange="calculateBalance(); autoSave();">
                    </div>
                    <div class="form-group">
                        <label>Report (N-1)</label>
                        <input type="number" id="report" value="0" min="0" step="1"
                            onchange="calculateBalance(); autoSave();">
                    </div>
                    <div class="form-group">
                        <label>5√®me Semaine</label>
                        <input type="number" id="cinquieme" value="6" min="0" step="1"
                            onchange="calculateBalance(); autoSave();">
                    </div>
                    <div class="form-group">
                        <label>Fractionnement (estim√© automatiquement)</label>
                        <input type="number" id="fractionnement" value="0" min="0" readonly
                            style="background: var(--bg);">
                    </div>
                    <div class="form-group">
                        <label>Jour de repos hebdomadaire</label>
                        <select id="weeklyRestDay" onchange="calculateBalance(); autoSave();">
                            <option value="0">Dimanche</option>
                            <option value="1">Lundi</option>
                            <option value="2">Mardi</option>
                            <option value="3">Mercredi</option>
                            <option value="4">Jeudi</option>
                            <option value="5">Vendredi</option>
                            <option value="6">Samedi</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="calculateBalance(); autoSave();">
                        üîÑ Recalculer le solde
                    </button>
                </div>

                <div class="card">
                    <h3><span class="card-icon">üíº</span> Votre Solde Actuel</h3>
                    <div class="balance-display">
                        <div class="balance-item">
                            <div class="balance-value" id="balancePrincipal">24</div>
                            <div class="balance-label">Principal</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-value" id="balanceCinquieme">6</div>
                            <div class="balance-label">5√®me Semaine</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-value" id="balanceFractionnement">0</div>
                            <div class="balance-label">Fractionnement</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-value" id="balanceAnciennete">0</div>
                            <div class="balance-label">Anciennet√©</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-value" id="balanceEnfant">0</div>
                            <div class="balance-label">Enfant</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-value" id="balanceReport">0</div>
                            <div class="balance-label">Report N-1</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Simulate -->
        <div id="simulateTab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3><span class="card-icon">üéØ</span> Simulation de Cong√©s</h3>
                    <div class="form-group">
                        <label>Date de d√©but</label>
                        <input type="date" id="simStartDate">
                    </div>
                    <div class="form-group">
                        <label>Date de fin</label>
                        <input type="date" id="simEndDate">
                    </div>
                    <button class="btn btn-primary" onclick="runSimulation()">
                        ‚ñ∂Ô∏è Lancer la simulation
                    </button>
                </div>

                <div class="card">
                    <h3><span class="card-icon">üìà</span> R√©sultat de la Simulation</h3>
                    <div id="simulationResult">
                        <p style="color: var(--text-light); text-align: center; padding: 40px;">
                            Configurez et lancez une simulation pour voir les r√©sultats
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: History -->
        <div id="historyTab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3><span class="card-icon">‚ûï</span> Ajouter une P√©riode</h3>
                    <div class="form-group">
                        <label>Date de d√©but</label>
                        <input type="date" id="newLeaveStart">
                    </div>
                    <div class="form-group">
                        <label>Date de fin</label>
                        <input type="date" id="newLeaveEnd">
                    </div>
                    <div class="form-group">
                        <label>Nombre de jours (optionnel - sera calcul√© automatiquement)</label>
                        <input type="number" id="newLeaveDays" min="0" step="1"
                            placeholder="Laisser vide pour calcul automatique">
                        <small style="color: var(--text-light); font-size: 0.85rem; display: block; margin-top: 5px;">
                            ‚ö†Ô∏è Les demi-journ√©es ne sont plus autoris√©es (r√®gle entreprise)
                        </small>
                    </div>
                    <button class="btn btn-primary" onclick="addLeavePeriod()">
                        ‚ûï Ajouter cette p√©riode
                    </button>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
                        <h4 style="color: var(--vinci-blue); margin-bottom: 15px;">üì• Import JSON (optionnel)</h4>
                        <div class="form-group">
                            <label>Importer un historique en JSON</label>
                            <textarea id="historyInput" rows="3"
                                placeholder='[{"debut": "2024-05-15", "fin": "2024-05-20", "jours": 5}]'></textarea>
                        </div>
                        <button class="btn btn-secondary" onclick="importHistory()">
                            üì• Importer depuis JSON
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3><span class="card-icon">üìã</span> Historique enregistr√©</h3>
                    <div class="table-container">
                        <div id="historyTableContainer" style="margin-top: 20px;">
                            <p style="color: var(--text-light); text-align: center; padding: 20px;">
                                Aucune p√©riode de cong√© enregistr√©e. Ajoutez votre premi√®re p√©riode ci-contre ou
                                utilisez le calendrier.
                            </p>
                        </div>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="analyzeHistory()" id="analyzeBtn"
                            style="display: none;">
                            üß† Analyser avec l'IA
                        </button>
                        <button class="btn btn-secondary" onclick="clearHistory()" id="clearBtn" style="display: none;">
                            üóëÔ∏è Effacer tout l'historique
                        </button>
                        <button class="btn btn-secondary" onclick="exportHistory()" id="exportBtn"
                            style="display: none;">
                            üíæ Exporter en JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Audit -->
        <div id="auditTab" class="tab-content">
            <div class="card">
                <h3><span class="card-icon">üîç</span> Audit Annuel</h3>
                <p style="margin-bottom: 20px; color: var(--text-light);">
                    V√©rifiez que votre d√©compte de jours sur l'ann√©e est correct.
                </p>
                <button class="btn btn-primary" onclick="runAudit()">
                    üîç Lancer l'audit
                </button>
                <div id="auditResults" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const JOURS_FERIES_2025 = [
            { date: '2025-01-01', nom: 'Jour de l\'an' },
            { date: '2025-04-21', nom: 'Lundi de P√¢ques' },
            { date: '2025-05-01', nom: 'F√™te du Travail' },
            { date: '2025-05-08', nom: 'Victoire 1945' },
            { date: '2025-05-29', nom: 'Ascension' },
            { date: '2025-06-09', nom: 'Lundi de Pentec√¥te' },
            { date: '2025-07-14', nom: 'F√™te Nationale' },
            { date: '2025-08-15', nom: 'Assomption' },
            { date: '2025-11-01', nom: 'Toussaint' },
            { date: '2025-11-11', nom: 'Armistice 1918' },
            { date: '2025-12-25', nom: 'No√´l' }
        ];

        const JOURS_FERIES_2026 = [
            { date: '2026-01-01', nom: 'Jour de l\'an' },
            { date: '2026-04-06', nom: 'Lundi de P√¢ques' },
            { date: '2026-05-01', nom: 'F√™te du Travail' },
            { date: '2026-05-08', nom: 'Victoire 1945' },
            { date: '2026-05-14', nom: 'Ascension' },
            { date: '2026-05-25', nom: 'Lundi de Pentec√¥te' },
            { date: '2026-07-14', nom: 'F√™te Nationale' },
            { date: '2026-08-15', nom: 'Assomption' },
            { date: '2026-11-01', nom: 'Toussaint' },
            { date: '2026-11-11', nom: 'Armistice 1918' },
            { date: '2026-12-25', nom: 'No√´l' }
        ];

        const publicHolidays = [
            '2024-01-01', '2024-04-01', '2024-05-01', '2024-05-08', '2024-05-09',
            '2024-05-20', '2024-07-14', '2024-08-15', '2024-11-01', '2024-11-11',
            '2024-12-25', '2025-01-01', '2025-04-21', '2025-05-01', '2025-05-08',
            '2025-05-29', '2025-06-09', '2025-07-14', '2025-08-15', '2025-11-01',
            '2025-11-11', '2025-12-25',
            '2026-01-01', '2026-04-06', '2026-05-01', '2026-05-08', '2026-05-14',
            '2026-05-25', '2026-07-14', '2026-08-15', '2026-11-01', '2026-11-11',
            '2026-12-25'
        ];

        // ===== √âTAT GLOBAL =====
        let currentBalance = {
            anciennete: 0,
            enfant: 0,
            report: 0,
            cinquieme: 6,
            fractionnement: 0,
            principal: 24
        };

        let leaveHistory = [];

        // √âtat du calendrier
        let currentDate = new Date();
        let selectedDates = []; // Dates de la p√©riode en cours de s√©lection
        let selectionMode = false;
        let rangeStart = null;
        let pendingPeriods = []; // Toutes les p√©riodes en attente de validation
        let suggestedPeriods = []; // P√©riodes sugg√©r√©es par l'IA pour visualisation

        // ===== FONCTIONS UTILITAIRES CNETP =====
        function isOuvrable(date, weeklyRestDay = 0) {
            // R√®gles CNETP standard : jours ouvrables = lundi √† samedi (6 jours/semaine)
            // Le dimanche (jour 0) est toujours non ouvrable
            // Le samedi (jour 6) est toujours ouvrable
            // Les jours f√©ri√©s sont non ouvrables

            const day = date.getDay();

            // Le dimanche (jour 0) est toujours non ouvrable selon les r√®gles CNETP
            if (day === 0) return false;

            // V√©rifier les jours f√©ri√©s
            const dateStr = date.toISOString().split('T')[0];
            if (publicHolidays.includes(dateStr)) return false;

            // Tous les autres jours (lundi=1 √† samedi=6) sont ouvrables
            return true;
        }

        function countOuvrables(start, end, weeklyRestDay = 0) {
            let count = 0;
            const current = new Date(start);
            const endDate = new Date(end);

            while (current <= endDate) {
                if (isOuvrable(current, weeklyRestDay)) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            return count;
        }

        function getLastOuvrableBefore(reprise, weeklyRestDay = 0) {
            // R√®gle CNETP : "Le dernier jour de cong√©s sera n√©cessairement le dernier jour ouvrable pr√©c√©dant la reprise du travail"
            // On recule depuis la date de reprise jusqu'√† trouver le dernier jour ouvrable

            // Cr√©er une copie de la date de reprise pour √©viter de modifier l'original
            let d = new Date(reprise);

            // Reculer d'un jour (le jour de reprise n'est pas inclus dans les cong√©s)
            d.setDate(d.getDate() - 1);

            // Continuer √† reculer jusqu'√† trouver un jour ouvrable
            // Protection contre les boucles infinies (ne devrait jamais arriver, mais s√©curit√©)
            let maxIterations = 10;
            let iterations = 0;

            while (!isOuvrable(d, weeklyRestDay) && iterations < maxIterations) {
                d.setDate(d.getDate() - 1);
                iterations++;
            }

            // V√©rification de s√©curit√©
            if (iterations >= maxIterations) {
                console.error('Erreur : impossible de trouver un jour ouvrable avant la reprise');
                // Retourner la date de reprise - 1 jour comme fallback
                d = new Date(reprise);
                d.setDate(d.getDate() - 1);
            }

            return d;
        }

        function imputeDays(rights, daysNeeded) {
            // R√®gle CNETP : Ordre d'imputation des jours de cong√©
            // 1. Anciennet√©
            // 2. Enfant
            // 3. Report (N-1)
            // 4. 5√®me semaine (6 jours) - jours 25 √† 30
            // 5. Fractionnement (0, 1 ou 2 jours selon les conditions)
            // 6. Principal (24 jours) - jours 1 √† 24
            //
            // CONFIRMATION ORDRE CNETP :
            // L'application suit strictement cet ordre d'imputation.
            // Les jours "bonus" (Anciennet√©, Enfant, Report) sont consomm√©s en PREMIER.
            // Le cong√© Principal (24 jours) est consomm√© en DERNIER.
            // Cela permet de pr√©server le Principal pour les calculs de fractionnement si n√©cessaire,
            // bien que cela puisse r√©duire les jours "Principal" pris en √©t√© si l'utilisateur a beaucoup d'anciennet√©.
            //
            // IMPORTANT : Le fractionnement se calcule UNIQUEMENT sur les 24 premiers jours (cong√© principal)
            // La 5√®me semaine (6 jours) est consomm√©e AVANT le principal, donc elle n'est jamais compt√©e pour le fractionnement

            const remaining = { ...rights };
            const consumed = {
                ANCIENNETE: 0,
                ENFANT: 0,
                REPORT: 0,
                CINQUIEME: 0,      // 5√®me semaine (6 jours) - consomm√©e AVANT le principal
                FRACTIONNEMENT: 0, // Calcul√© apr√®s, consomm√© AVANT le principal
                PRINCIPAL: 0       // Cong√© principal (24 jours) - consomm√© EN DERNIER
            };

            let leftToConsume = daysNeeded;
            const order = ['anciennete', 'enfant', 'report', 'cinquieme', 'fractionnement', 'principal'];
            const orderMap = {
                'anciennete': 'ANCIENNETE',
                'enfant': 'ENFANT',
                'report': 'REPORT',
                'cinquieme': 'CINQUIEME',      // 5√®me semaine consomm√©e en 4√®me position
                'fractionnement': 'FRACTIONNEMENT', // Fractionnement consomm√© en 5√®me position
                'principal': 'PRINCIPAL'       // Principal consomm√© en dernier (24 jours)
            };

            // Consommer les jours dans l'ordre CNETP
            for (const type of order) {
                if (leftToConsume <= 0) break;
                const available = remaining[type];
                const toConsume = Math.min(available, leftToConsume);
                remaining[type] -= toConsume;
                consumed[orderMap[type]] = toConsume;
                leftToConsume -= toConsume;
            }

            return { remaining, consumed, totalConsumed: daysNeeded - leftToConsume };
        }

        function calculateSeniorityDays() {
            const category = document.getElementById('userCategory').value;
            let days = 0;

            if (category === 'ouvrier') {
                const years = parseInt(document.getElementById('serviceYears').value) || 0;
                // R√®gle Ouvriers :
                // 20 ans et < 25 ans : 2 jours
                // 25 ans et < 30 ans : 4 jours
                // 30 ans et plus : 6 jours
                if (years >= 30) days = 6;
                else if (years >= 25) days = 4;
                else if (years >= 20) days = 2;
                else days = 0;
            } else {
                // R√®gle ETAM / Cadres :
                const companyYears = parseInt(document.getElementById('companySeniority').value) || 0;
                const professionYears = parseInt(document.getElementById('professionSeniority').value) || 0;

                // Dans l'entreprise : 5-10 ans = 2j, >10 ans = 3j
                // Dans la profession : 10-20 ans = 2j, >20 ans = 3j
                // On prend le plus favorable des deux (r√®gle implicite du "ou") ou le cumul ?
                // G√©n√©ralement c'est "si condition A OU condition B".
                // Le tableau indique "Cong√©s suppl√©mentaires" pour chaque colonne.
                // Interpr√©tation standard : on v√©rifie pour 3 jours, sinon pour 2 jours.

                // Pour 3 jours : >10 ans Ent OU >20 ans Prof
                // Le tableau dit "10 ans et plus" (Ent) -> 3j
                // "20 ans et plus" (Prof) -> 3j
                if (companyYears >= 10 || professionYears >= 20) {
                    days = 3;
                }
                // Pour 2 jours : 5-10 ans Ent OU 10-20 ans Prof
                else if (companyYears >= 5 || professionYears >= 10) {
                    days = 2;
                } else {
                    days = 0;
                }
            }

            return days;
        }

        function toggleSeniorityInputs() {
            const category = document.getElementById('userCategory').value;
            const ouvrierInputs = document.getElementById('ouvrierInputs');
            const etamInputs = document.getElementById('etamInputs');

            if (category === 'ouvrier') {
                ouvrierInputs.style.display = 'block';
                etamInputs.style.display = 'none';
            } else {
                ouvrierInputs.style.display = 'none';
                etamInputs.style.display = 'block';
            }
        }

        function calculateFractionnement(params) {
            // R√®gles CNETP officielles pour le fractionnement (3 conditions cumulatives) :
            // 
            // POUR 1 JOUR SUPPL√âMENTAIRE :
            // 1. Avoir pris au moins 12 jours continus sur les 24 premiers jours du cong√© l√©gal (du principal)
            // 2. Avoir pris au maximum 21 jours ouvrables entre le 1er mai et le 31 octobre (du principal)
            // 3. Prendre 3 √† 5 jours ouvrables de cong√© entre le 1er novembre et le 30 avril (du principal)
            //
            // POUR 2 JOURS SUPPL√âMENTAIRES :
            // 1. Avoir pris au moins 12 jours continus sur les 24 premiers jours du cong√© l√©gal (du principal)
            // 2. Avoir pris au maximum 18 jours ouvrables entre le 1er mai et le 31 octobre (du principal)
            // 3. Prendre 6 jours ouvrables de cong√© entre le 1er novembre et le 30 avril (du principal)

            // Condition 1 : 12 jours continus du principal en √©t√©
            if (!params.isContinuous12Summer) return 0;

            // V√©rifier que les 12 jours continus sont bien du principal (pas de la 5√®me semaine)
            if (params.principalDaysTakenSummer < 12) return 0;

            // Condition 2 : Maximum de jours en √©t√© (du principal)
            // Pour +2 jours : maximum 18 jours en √©t√©
            // Pour +1 jour : maximum 21 jours en √©t√©
            if (params.principalDaysTakenSummer > 21) return 0; // Au-del√† de 21, aucun fractionnement

            // Condition 3 : Jours en hiver (du principal)
            const daysWinter = params.principalDaysTakenWinter;

            // V√©rifier d'abord pour 2 jours suppl√©mentaires
            if (params.principalDaysTakenSummer <= 18 && daysWinter === 6) {
                return 2;
            }

            // V√©rifier pour 1 jour suppl√©mentaire
            if (params.principalDaysTakenSummer <= 21 && daysWinter >= 3 && daysWinter <= 5) {
                return 1;
            }

            return 0;
        }

        // ===== INTERFACE =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Rafra√Æchir le calendrier si on bascule dessus
            if (tabName === 'calendar') {
                renderCalendar();
            }
        }

        function updateAIMessage(message, type = 'info') {
            const aiMessage = document.getElementById('aiMessage');
            const suggestionsDiv = document.getElementById('aiSuggestions');

            // Garder le message principal et ajouter les suggestions
            const baseMessage = message.includes('<strong>üëã') ? message :
                `<strong>üí¨ Assistant IA :</strong><br>${message}`;

            aiMessage.innerHTML = baseMessage;
            if (suggestionsDiv) {
                suggestionsDiv.innerHTML = '';
            }

            aiMessage.style.borderLeftColor = type === 'success' ? 'var(--success)' :
                type === 'warning' ? 'var(--warning)' :
                    type === 'error' ? 'var(--danger)' : 'var(--vinci-blue)';
        }

        function addAISuggestion(title, description, action) {
            const suggestionsDiv = document.getElementById('aiSuggestions');
            if (!suggestionsDiv) return;

            const suggestion = document.createElement('div');
            suggestion.className = 'ai-suggestion';
            suggestion.innerHTML = `
                <div class="ai-suggestion-title">üí° ${title}</div>
                <div class="ai-suggestion-desc">${description}</div>
            `;
            if (action) {
                suggestion.onclick = action;
            }
            suggestionsDiv.appendChild(suggestion);
        }

        // ===== CALENDRIER =====
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Mise √† jour du titre
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

            // Cr√©ation de la grille
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // En-t√™tes des jours
            const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Premier jour du mois
            const firstDay = new Date(year, month, 1);
            let dayOfWeek = firstDay.getDay();
            dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            // Derniers jours du mois pr√©c√©dent
            const prevMonthDays = new Date(year, month, 0).getDate();
            for (let i = dayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                const cell = createDayCell(year, month - 1, day, true);
                grid.appendChild(cell);
            }

            // Jours du mois actuel
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = createDayCell(year, month, day, false);
                grid.appendChild(cell);
            }

            // Premiers jours du mois suivant
            const remainingCells = 42 - grid.children.length + 7;
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createDayCell(year, month + 1, day, true);
                grid.appendChild(cell);
            }
        }

        function createDayCell(year, month, day, otherMonth) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';

            const date = new Date(year, month, day);
            const dateStr = formatDate(date);

            if (otherMonth) {
                cell.classList.add('other-month');
            }

            // Weekend - R√®gles CNETP standard : seul le dimanche (jour 0) est non ouvrable
            // Le samedi (jour 6) est un jour ouvrable
            const dayOfWeek = date.getDay();
            // Toujours consid√©rer le dimanche comme weekend selon les r√®gles CNETP
            if (dayOfWeek === 0) {
                cell.classList.add('weekend');
            }

            // Jour f√©ri√©
            if (isHoliday(dateStr)) {
                cell.classList.add('holiday');
            }

            // S√©lectionn√© (p√©riode en cours)
            if (selectedDates.includes(dateStr)) {
                cell.classList.add('selected');
            }

            // P√©riodes en attente
            pendingPeriods.forEach(period => {
                if (period.dates && period.dates.includes(dateStr)) {
                    cell.classList.add('selected');
                }
            });

            // Range selection (p√©riode en cours de s√©lection)
            if (rangeStart && selectionMode) {
                const start = new Date(rangeStart);
                if (date >= start) {
                    if (dateStr === rangeStart) {
                        cell.classList.add('range-start');
                    } else {
                        cell.classList.add('in-range');
                    }
                }
            }

            // V√©rifier la r√®gle du 1 mois √† l'avance (r√®gle entreprise)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const daysUntilDate = Math.floor((date - today) / (1000 * 60 * 60 * 24));
            if (daysUntilDate < 30 && daysUntilDate >= 0) {
                // Date dans moins de 30 jours - ne respecte pas la r√®gle du 1 mois √† l'avance
                cell.classList.add('too-early');
                const daysShort = 30 - daysUntilDate;
                cell.title = `‚ö†Ô∏è R√®gle entreprise : Vous devez poser vos cong√©s au moins 1 mois (30 jours) √† l'avance. Il manque ${daysShort} jour(s).`;
            } else if (daysUntilDate < 0) {
                // Date dans le pass√©
                cell.classList.add('past-date');
                cell.title = '‚ùå Cette date est dans le pass√©.';
            }

            // P√©riodes sugg√©r√©es par l'IA
            suggestedPeriods.forEach((suggestion, suggestionIndex) => {
                if (suggestion.dates && suggestion.dates.includes(dateStr)) {
                    if (dateStr === suggestion.start || dateStr === suggestion.end) {
                        cell.classList.add('suggested-start', 'suggested-end');
                    } else {
                        cell.classList.add('suggested');
                    }
                    // Permettre de cliquer sur une p√©riode sugg√©r√©e pour l'appliquer
                    cell.style.cursor = 'pointer';
                    cell.title = `üí° ${suggestion.name || 'P√©riode sugg√©r√©e'} - Cliquez pour ajouter`;
                }
            });

            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            cell.appendChild(dayNumber);

            // Indicateur si p√©riode enregistr√©e
            if (hasLeaveOnDate(dateStr)) {
                const indicator = document.createElement('div');
                indicator.className = 'day-indicator';
                cell.appendChild(indicator);
            }

            // G√©rer le clic : si c'est une p√©riode sugg√©r√©e, l'appliquer directement
            cell.onclick = () => {
                // V√©rifier si on clique sur une p√©riode sugg√©r√©e
                const clickedSuggestion = suggestedPeriods.find(suggestion =>
                    suggestion.dates && suggestion.dates.includes(dateStr)
                );

                if (clickedSuggestion) {
                    // Appliquer la suggestion
                    applySuggestion(clickedSuggestion.start, clickedSuggestion.end, clickedSuggestion.dates);
                } else {
                    // Comportement normal de s√©lection
                    selectDate(dateStr, date);
                }
            };

            return cell;
        }

        function selectDate(dateStr, date) {
            if (!selectionMode) {
                // Premier clic - d√©but d'une nouvelle p√©riode
                rangeStart = dateStr;
                selectionMode = true;
                selectedDates = [dateStr];
                updateSelectionInfo();
            } else {
                // Deuxi√®me clic - fin de la p√©riode
                const start = new Date(rangeStart);
                const end = date;

                // V√©rifier que la fin est apr√®s le d√©but
                if (end < start) {
                    updateAIMessage('‚ö†Ô∏è La date de fin doit √™tre apr√®s la date de d√©but', 'warning');
                    return;
                }

                // Validation : d√©lai minimum de 1 mois entre p√©riodes (r√®gle CNETP)
                const validationError = validatePeriodGap(start, end);
                if (validationError) {
                    updateAIMessage(validationError, 'error');
                    return;
                }

                // Calculer le dernier jour ouvrable avant la reprise
                const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
                const reprise = new Date(end);
                reprise.setDate(reprise.getDate() + 1);
                const lastOuvrable = getLastOuvrableBefore(reprise, weeklyRestDay);

                // G√©n√©rer toutes les dates de la p√©riode (du d√©but √† la fin s√©lectionn√©e)
                selectedDates = [];
                let current = new Date(start);
                const endDate = new Date(end);

                while (current <= endDate) {
                    selectedDates.push(formatDate(current));
                    current.setDate(current.getDate() + 1);
                }

                // Calculer les jours ouvrables jusqu'au dernier jour ouvrable avant la reprise
                const workDays = countOuvrables(start, lastOuvrable, weeklyRestDay);

                // Ajouter cette p√©riode √† la liste des p√©riodes en attente
                pendingPeriods.push({
                    start: formatDate(new Date(start)),
                    end: formatDate(end),
                    lastOuvrable: formatDate(lastOuvrable),
                    dates: [...selectedDates],
                    jours: workDays
                });

                // R√©initialiser pour la prochaine s√©lection
                selectedDates = [];
                rangeStart = null;
                selectionMode = false;

                updateSelectionInfo();

                // Analyser automatiquement la s√©lection
                setTimeout(() => analyzeSelection(pendingPeriods[pendingPeriods.length - 1]), 500);
            }

            renderCalendar();
        }

        // Validation du d√©lai minimum de 1 mois entre p√©riodes (r√®gle CNETP)
        // Validation : obligation de poser les cong√©s 1 mois √† l'avance (r√®gle entreprise)
        function validateOneMonthAdvance(startDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // R√©initialiser l'heure pour la comparaison

            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);

            // Calculer la diff√©rence en jours
            const daysUntilStart = Math.floor((start - today) / (1000 * 60 * 60 * 24));

            // R√®gle entreprise : il faut poser les cong√©s au moins 1 mois (30 jours) avant la date de d√©part
            if (daysUntilStart < 30) {
                const daysShort = 30 - daysUntilStart;
                if (daysUntilStart < 0) {
                    return `‚ùå <strong>R√®gle entreprise non respect√©e :</strong> Vous ne pouvez pas poser des cong√©s dans le pass√©. La date de d√©but doit √™tre au moins 1 mois apr√®s aujourd'hui (${formatDisplayDate(today.toISOString().split('T')[0])}).`;
                } else {
                    return `‚ùå <strong>R√®gle entreprise non respect√©e :</strong> Vous devez poser vos cong√©s au moins 1 mois (30 jours) avant votre date de d√©part selon le courrier du 2 avril 2025. Il vous manque ${daysShort} jour(s). Date minimale autoris√©e : ${formatDisplayDate(new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0])}.`;
                }
            }

            return null; // Pas d'erreur
        }

        function validatePeriodGap(start, end) {
            // Validation 1 : obligation de poser les cong√©s 1 mois √† l'avance (r√®gle entreprise)
            const advanceError = validateOneMonthAdvance(start);
            if (advanceError) {
                return advanceError;
            }

            if (leaveHistory.length === 0) return null; // Pas de validation suppl√©mentaire si c'est la premi√®re p√©riode

            // V√©rifier qu'il y a au moins 1 mois (30 jours) entre cette p√©riode et les autres
            const periodStart = new Date(start);
            const periodEnd = new Date(end);

            for (const existingLeave of leaveHistory) {
                const existingStart = new Date(existingLeave.debut);
                const existingEnd = new Date(existingLeave.fin);

                // V√©rifier si les p√©riodes se chevauchent
                if ((periodStart <= existingEnd && periodEnd >= existingStart)) {
                    return '‚ùå Cette p√©riode chevauche une p√©riode existante. Les p√©riodes ne peuvent pas se chevaucher.';
                }
            }

            return null; // Pas d'erreur
        }

        // Analyser automatiquement une s√©lection
        function analyzeSelection(period) {
            if (!period) return;

            const start = new Date(period.start);
            const month = start.getMonth();
            const workDays = period.jours;

            let analysis = `üìä <strong>Analyse automatique de votre s√©lection :</strong><br><br>`;
            analysis += `üìÖ Du ${formatDisplayDate(period.start)} au ${formatDisplayDate(period.end)}<br>`;
            analysis += `üìä ${workDays} jours ouvrables<br><br>`;

            // Conseils selon la p√©riode selon les r√®gles CNETP officielles
            if (month >= 4 && month <= 9) {
                analysis += `‚òÄÔ∏è <strong>P√©riode estivale (1er mai - 31 octobre)</strong> :<br>`;
                if (workDays >= 12) {
                    analysis += `‚úÖ Cette p√©riode respecte la condition des 12 jours continus du principal pour le fractionnement.<br>`;
                } else {
                    analysis += `‚ö†Ô∏è Pour le fractionnement, vous devez prendre au moins 12 jours continus du principal (sur les 24 premiers jours) en √©t√©.<br>`;
                }
                analysis += `üí° <strong>Rappel CNETP :</strong> Pour obtenir le fractionnement, vous devez prendre au maximum 21 jours du principal en √©t√© (pour +1 jour) ou 18 jours (pour +2 jours).<br>`;
            } else {
                analysis += `‚ùÑÔ∏è <strong>P√©riode hivernale (1er novembre - 30 avril)</strong> :<br>`;
                analysis += `üí° <strong>Rappel CNETP :</strong> Pour obtenir le fractionnement, vous devez prendre 3 √† 5 jours du principal en hiver (pour +1 jour) ou exactement 6 jours (pour +2 jours), en plus d'avoir pris 12 jours continus du principal en √©t√©.<br>`;
            }

            // V√©rifier l'√©ch√©ance du 15 mai
            const today = new Date();
            const may15 = new Date(today.getFullYear(), 4, 15); // 15 mai
            const daysUntilMay15 = Math.floor((may15 - today) / (1000 * 60 * 60 * 24));

            if (daysUntilMay15 > 0 && daysUntilMay15 <= 30) {
                analysis += `<br>‚ö†Ô∏è <strong>Rappel important :</strong> La date limite pour poser vos cong√©s est le <strong>15 mai</strong> (dans ${daysUntilMay15} jour(s)).`;
            }

            updateAIMessage(analysis, 'info');
        }

        function updateSelectionInfo() {
            const info = document.getElementById('selectionInfo');
            const periodsList = document.getElementById('periodsList');
            const selectionTotal = document.getElementById('selectionTotal');

            // Afficher si on a des p√©riodes en attente ou une s√©lection en cours
            if (pendingPeriods.length > 0 || (selectedDates.length > 0 && selectionMode)) {
                info.style.display = 'block';

                // Afficher la p√©riode en cours de s√©lection si elle existe
                let html = '';

                // P√©riode en cours de s√©lection (si pas encore compl√©t√©e)
                if (selectedDates.length > 0 && selectionMode && rangeStart) {
                    const start = selectedDates[0];
                    const end = selectedDates.length > 1 ? selectedDates[selectedDates.length - 1] : start;
                    const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
                    const workDays = countWorkDaysFromDates(selectedDates, weeklyRestDay);

                    html += `
                        <div class="period-item" style="border-color: var(--warning);">
                            <div class="period-info">
                                <div class="period-dates">‚è≥ En cours : Du ${formatDisplayDate(start)} au ${formatDisplayDate(end)}</div>
                                <div class="period-days">${workDays} jours ouvrables - Cliquez sur une date de fin pour finaliser</div>
                            </div>
                        </div>
                    `;
                }

                // P√©riodes en attente de validation
                pendingPeriods.forEach((period, index) => {
                    const lastOuvrableInfo = period.lastOuvrable ? ` (dernier ouvrable: ${formatDisplayDate(period.lastOuvrable)})` : '';
                    html += `
                        <div class="period-item">
                            <div class="period-info">
                                <div class="period-dates">üìÖ Du ${formatDisplayDate(period.start)} au ${formatDisplayDate(period.end)}</div>
                                <div class="period-days">${period.jours} jours ouvrables${lastOuvrableInfo}</div>
                            </div>
                            <div class="period-actions">
                                <button class="btn btn-success btn-small" onclick="confirmSinglePeriod(${index})">‚úì Valider</button>
                                <button class="btn btn-danger btn-small" onclick="removePendingPeriod(${index})">‚úó Supprimer</button>
                            </div>
                        </div>
                    `;
                });

                periodsList.innerHTML = html;

                // Calculer le total
                const totalDays = pendingPeriods.reduce((sum, p) => sum + p.jours, 0);
                selectionTotal.textContent = `${totalDays} jours ouvrables`;
            } else {
                info.style.display = 'none';
            }
        }

        function confirmAllSelections() {
            if (pendingPeriods.length === 0) {
                updateAIMessage('‚ö†Ô∏è Aucune p√©riode √† valider. S√©lectionnez d\'abord des p√©riodes sur le calendrier.', 'warning');
                return;
            }

            // Valider toutes les p√©riodes avant de les ajouter
            for (const period of pendingPeriods) {
                const start = new Date(period.start);
                const end = new Date(period.end);

                // Validation : obligation de poser les cong√©s 1 mois √† l'avance
                const advanceError = validateOneMonthAdvance(start);
                if (advanceError) {
                    updateAIMessage(advanceError, 'error');
                    return;
                }

                // Validation : d√©lai minimum entre p√©riodes
                const gapError = validatePeriodGap(start, end);
                if (gapError && !gapError.includes('R√®gle entreprise')) { // √âviter les doublons
                    updateAIMessage(gapError, 'error');
                    return;
                }
            }

            let totalDays = 0;
            let addedCount = 0;

            pendingPeriods.forEach(period => {
                // R√®gle CNETP : stocker le dernier jour ouvrable r√©el, pas la date de fin s√©lectionn√©e
                const finReelle = period.lastOuvrable || period.end;
                leaveHistory.push({
                    debut: period.start,
                    fin: finReelle, // Utiliser le dernier jour ouvrable r√©el
                    finSelectionnee: period.end, // Garder la date s√©lectionn√©e pour r√©f√©rence
                    jours: period.jours,
                    dates: [...period.dates]
                });
                totalDays += period.jours;
                addedCount++;
            });

            // R√©initialiser
            pendingPeriods = [];
            selectedDates = [];
            rangeStart = null;
            selectionMode = false;

            renderCalendar();
            renderHistoryTable();
            updateStats();
            calculateBalance(); // Recalculer le solde avec le fractionnement mis √† jour
            autoSave(); // Sauvegarder

            // Message intelligent
            let message = `‚úÖ <strong>${addedCount} p√©riode(s) ajout√©e(s) avec succ√®s !</strong><br><br>`;
            message += `üìä Total : ${totalDays} jours ouvrables consomm√©s<br><br>`;

            // Calculer le solde restant (apr√®s recalcul)
            const totalTaken = leaveHistory.reduce((sum, l) => sum + l.jours, 0);
            const totalAvailable = currentBalance.principal + currentBalance.cinquieme +
                currentBalance.fractionnement + currentBalance.anciennete +
                currentBalance.enfant + currentBalance.report;
            const remaining = totalAvailable - totalTaken;

            message += `üí∞ <strong>Solde restant estim√© :</strong> ${remaining} jours`;

            if (remaining < 5) {
                message += `<br>‚ö†Ô∏è Attention, votre solde est faible. Planifiez bien vos prochaines p√©riodes.`;
            }

            updateAIMessage(message, 'success');
            updateSelectionInfo();
        }

        function confirmSinglePeriod(index) {
            if (index < 0 || index >= pendingPeriods.length) return;

            const period = pendingPeriods[index];
            const start = new Date(period.start);
            const end = new Date(period.end);
            const month = start.getMonth();

            // Validation : obligation de poser les cong√©s 1 mois √† l'avance
            const advanceError = validateOneMonthAdvance(start);
            if (advanceError) {
                updateAIMessage(advanceError, 'error');
                return;
            }

            // Validation : d√©lai minimum entre p√©riodes
            const gapError = validatePeriodGap(start, end);
            if (gapError && !gapError.includes('R√®gle entreprise')) { // √âviter les doublons
                updateAIMessage(gapError, 'error');
                return;
            }

            // R√®gle CNETP : stocker le dernier jour ouvrable r√©el, pas la date de fin s√©lectionn√©e
            const finReelle = period.lastOuvrable || period.end;
            leaveHistory.push({
                debut: period.start,
                fin: finReelle, // Utiliser le dernier jour ouvrable r√©el
                finSelectionnee: period.end, // Garder la date s√©lectionn√©e pour r√©f√©rence
                jours: period.jours,
                dates: [...period.dates]
            });

            // Retirer de la liste des p√©riodes en attente
            pendingPeriods.splice(index, 1);

            renderCalendar();
            renderHistoryTable();
            updateStats();
            calculateBalance(); // Recalculer le solde avec le fractionnement mis √† jour
            autoSave(); // Sauvegarder
            updateSelectionInfo();

            // Message intelligent avec conseils
            let message = `‚úÖ <strong>P√©riode ajout√©e avec succ√®s !</strong><br><br>`;
            message += `üìÖ Du ${formatDisplayDate(period.start)} au ${formatDisplayDate(period.end)}<br>`;
            message += `üìä ${period.jours} jours ouvrables consomm√©s<br><br>`;

            // Conseils selon la p√©riode
            if (month >= 4 && month <= 9) {
                message += `‚òÄÔ∏è <strong>P√©riode estivale</strong> : `;
                if (period.jours >= 12) {
                    message += `Excellent ! Vous respectez la condition des 12 jours continus pour le fractionnement.`;
                } else {
                    message += `Pensez √† prendre au moins 12 jours continus en √©t√© pour √™tre √©ligible au fractionnement.`;
                }
            } else {
                message += `‚ùÑÔ∏è <strong>P√©riode hivernale</strong> : `;
                const totalTaken = leaveHistory.reduce((sum, l) => {
                    const lMonth = new Date(l.debut).getMonth();
                    return (lMonth < 4 || lMonth > 9) ? sum + l.jours : sum;
                }, 0);
                if (totalTaken >= 6) {
                    message += `Parfait ! Vous avez ${totalTaken} jours en hiver, ce qui vous donne droit au fractionnement maximum (+2 jours).`;
                } else if (totalTaken >= 3) {
                    message += `Bien ! Vous avez ${totalTaken} jours en hiver, ce qui vous donne droit √† +1 jour de fractionnement.`;
                } else {
                    message += `Pour optimiser, essayez de prendre 3-6 jours du principal en hiver pour obtenir le fractionnement.`;
                }
            }

            // Calculer le solde restant
            const totalTaken = leaveHistory.reduce((sum, l) => sum + l.jours, 0);
            const totalAvailable = currentBalance.principal + currentBalance.cinquieme +
                currentBalance.fractionnement + currentBalance.anciennete +
                currentBalance.enfant + currentBalance.report;
            const remaining = totalAvailable - totalTaken;

            message += `<br><br>üí∞ <strong>Solde restant estim√© :</strong> ${remaining} jours`;

            if (remaining < 5) {
                message += `<br>‚ö†Ô∏è Attention, votre solde est faible. Planifiez bien vos prochaines p√©riodes.`;
            }

            updateAIMessage(message, 'success');
        }

        function removePendingPeriod(index) {
            if (index < 0 || index >= pendingPeriods.length) return;

            pendingPeriods.splice(index, 1);
            renderCalendar();
            updateSelectionInfo();

            if (pendingPeriods.length === 0 && !selectionMode) {
                updateAIMessage('‚ÑπÔ∏è P√©riode supprim√©e. Vous pouvez continuer √† s√©lectionner d\'autres p√©riodes.', 'info');
            }
        }

        function cancelSelection() {
            selectedDates = [];
            rangeStart = null;
            selectionMode = false;
            renderCalendar();
            updateSelectionInfo();
        }

        function clearSelection() {
            selectedDates = [];
            rangeStart = null;
            selectionMode = false;
            renderCalendar();
            updateSelectionInfo();
        }

        function clearAllSelections() {
            if (pendingPeriods.length === 0 && !selectionMode) {
                updateAIMessage('‚ÑπÔ∏è Aucune s√©lection en cours.', 'info');
                return;
            }

            if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les p√©riodes s√©lectionn√©es ?')) {
                pendingPeriods = [];
                selectedDates = [];
                rangeStart = null;
                selectionMode = false;
                renderCalendar();
                updateSelectionInfo();
                updateAIMessage('‚úÖ Toutes les s√©lections ont √©t√© effac√©es.', 'success');
            }
        }

        function clearSuggestions() {
            suggestedPeriods = [];
            renderCalendar();
            document.getElementById('suggestionsInfo').style.display = 'none';
            document.getElementById('clearSuggestionsBtn').style.display = 'none';
            updateAIMessage('‚úÖ Suggestions effac√©es du calendrier.', 'success');
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        // ===== OPTIMISATIONS IA =====
        function optimizeSelection() {
            // Utiliser la p√©riode en cours de s√©lection ou la derni√®re p√©riode en attente
            let periodToOptimize = null;

            if (selectedDates.length > 0 && selectionMode) {
                // P√©riode en cours de s√©lection
                const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
                periodToOptimize = {
                    start: selectedDates[0],
                    end: selectedDates[selectedDates.length - 1],
                    dates: selectedDates,
                    jours: countWorkDaysFromDates(selectedDates, weeklyRestDay)
                };
            } else if (pendingPeriods.length > 0) {
                // Utiliser la derni√®re p√©riode en attente
                periodToOptimize = pendingPeriods[pendingPeriods.length - 1];
            } else {
                updateAIMessage('‚ö†Ô∏è Veuillez d\'abord s√©lectionner une p√©riode sur le calendrier', 'warning');
                return;
            }

            const start = new Date(periodToOptimize.start);
            const end = new Date(periodToOptimize.end);
            const workDays = periodToOptimize.jours;

            const optimizations = generateOptimizations(start, end, workDays);
            renderOptimizations(optimizations);

            let message = `üéØ J'ai analys√© votre p√©riode et trouv√© ${optimizations.length} optimisation(s) possible(s) !`;

            // Conseils personnalis√©s selon la p√©riode
            const month = start.getMonth();
            if (month >= 4 && month <= 9) {
                message += '<br><br>‚òÄÔ∏è <strong>P√©riode estivale d√©tect√©e</strong> : Parfait pour votre p√©riode principale. ';
                if (workDays >= 12) {
                    message += 'Vous respectez la condition des 12 jours continus pour le fractionnement !';
                } else {
                    message += `Pensez √† prendre au moins 12 jours continus en √©t√© pour √™tre √©ligible au fractionnement.`;
                }
            } else {
                message += '<br><br>‚ùÑÔ∏è <strong>P√©riode hivernale</strong> : Excellente strat√©gie pour optimiser le fractionnement !';
            }

            if (pendingPeriods.length > 1) {
                message += `<br><br>üí° Vous avez ${pendingPeriods.length} p√©riodes en attente. Vous pouvez optimiser chaque p√©riode individuellement.`;
            }

            updateAIMessage(message, 'success');

            // Suggestions suppl√©mentaires
            if (optimizations.length > 0) {
                optimizations.forEach(opt => {
                    if (opt.gain > 0) {
                        addAISuggestion(
                            opt.title,
                            opt.description,
                            () => applyOptimization(optimizations.indexOf(opt))
                        );
                    }
                });
            }
        }

        function generateOptimizations(start, end, currentDays) {
            const optimizations = [];

            // Optimisation 1 : Ponts
            const bridges = findBridges(start, end);
            if (bridges.length > 0) {
                bridges.forEach(bridge => {
                    optimizations.push({
                        title: `üåâ Faire le pont de ${bridge.holiday}`,
                        description: `En posant ${bridge.extraDays} jour(s) suppl√©mentaire(s), vous obtenez ${bridge.totalDays} jours de repos cons√©cutifs`,
                        newStart: bridge.newStart,
                        newEnd: bridge.newEnd,
                        extraDays: bridge.extraDays,
                        totalDays: bridge.totalDays,
                        gain: bridge.totalDays - currentDays,
                        efficiency: (bridge.totalDays / (currentDays + bridge.extraDays) * 100).toFixed(0)
                    });
                });
            }

            // Optimisation 2 : Fractionnement
            const fractOptim = optimizeFractionnement(start, end, currentDays);
            if (fractOptim) {
                optimizations.push(fractOptim);
            }

            // Optimisation 3 : Weekends
            const weekendOptim = optimizeWeekends(start, end, currentDays);
            if (weekendOptim) {
                optimizations.push(weekendOptim);
            }

            // Optimisation 4 : P√©riode estivale
            const summerOptim = optimizeSummerPeriod(start, end, currentDays);
            if (summerOptim) {
                optimizations.push(summerOptim);
            }

            return optimizations;
        }

        function findBridges(start, end) {
            const bridges = [];
            const nearby = JOURS_FERIES_2025.filter(h => {
                const holidayDate = new Date(h.date);
                const diffDays = Math.abs((holidayDate - start) / (1000 * 60 * 60 * 24));
                return diffDays <= 5;
            });

            nearby.forEach(holiday => {
                const holidayDate = new Date(holiday.date);
                const dayOfWeek = holidayDate.getDay();

                if (dayOfWeek === 4) {
                    bridges.push({
                        holiday: holiday.nom,
                        extraDays: 1,
                        totalDays: 4,
                        newStart: formatDate(holidayDate),
                        newEnd: formatDate(new Date(holidayDate.getFullYear(), holidayDate.getMonth(), holidayDate.getDate() + 3))
                    });
                }

                if (dayOfWeek === 2) {
                    bridges.push({
                        holiday: holiday.nom,
                        extraDays: 1,
                        totalDays: 4,
                        newStart: formatDate(new Date(holidayDate.getFullYear(), holidayDate.getMonth(), holidayDate.getDate() - 3)),
                        newEnd: formatDate(holidayDate)
                    });
                }
            });

            return bridges;
        }

        function optimizeFractionnement(start, end, currentDays) {
            const month = start.getMonth();

            if (month >= 4 && month <= 9) {
                if (currentDays >= 12) {
                    const winterDaysNeeded = 6;
                    return {
                        title: `üéÅ Maximiser le fractionnement`,
                        description: `Gardez ${winterDaysNeeded} jours pour l'hiver (Nov-Avr) pour obtenir +2 jours de fractionnement`,
                        extraDays: 0,
                        totalDays: currentDays,
                        gain: 2,
                        efficiency: 100,
                        tip: `En prenant vos cong√©s principaux en √©t√© et en gardant quelques jours pour l'hiver, vous gagnez des jours bonus !`
                    };
                }
            }

            return null;
        }

        function optimizeWeekends(start, end, currentDays) {
            const startDay = start.getDay();

            if (startDay !== 1 && startDay !== 0) {
                const daysToMonday = startDay === 0 ? 1 : (8 - startDay);
                return {
                    title: `üìÖ Optimiser les weekends`,
                    description: `Commencez votre cong√© un lundi pour maximiser les weekends inclus`,
                    extraDays: 0,
                    gain: daysToMonday > 3 ? 0 : 2,
                    tip: `En calant vos cong√©s du lundi au vendredi, vous profitez des weekends sans les consommer`
                };
            }

            return null;
        }

        function optimizeSummerPeriod(start, end, currentDays) {
            const month = start.getMonth();

            if (month >= 4 && month <= 9 && currentDays >= 12) {
                return {
                    title: `‚òÄÔ∏è P√©riode estivale optimale`,
                    description: `Votre p√©riode respecte les conditions pour le fractionnement (12 jours continus en √©t√©)`,
                    extraDays: 0,
                    totalDays: currentDays,
                    gain: 0,
                    efficiency: 100,
                    tip: `Parfait pour obtenir vos jours de fractionnement !`
                };
            }

            return null;
        }

        function renderOptimizations(optimizations) {
            const container = document.getElementById('optimizations');

            if (optimizations.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--text-light); text-align: center; padding: 40px;">
                        Aucune optimisation trouv√©e pour cette p√©riode
                    </p>
                `;
                return;
            }

            container.innerHTML = optimizations.map((opt, index) => `
                <div class="optimization-card" onclick="applyOptimization(${index})">
                    <div class="optimization-header">
                        <div class="optimization-title">${opt.title}</div>
                        <div class="optimization-badge">+${opt.gain} jour${opt.gain > 1 ? 's' : ''}</div>
                    </div>
                    <div class="optimization-details">${opt.description}</div>
                    ${opt.tip ? `<div style="font-size: 0.9rem; color: var(--text-light); margin-top: 10px;">üí° ${opt.tip}</div>` : ''}
                    <div class="optimization-gain">
                        <div class="gain-item">
                            <div class="gain-label">Jours √† poser</div>
                            <div class="gain-value">${opt.totalDays || selectedDates.length + opt.extraDays}</div>
                        </div>
                        <div class="gain-item">
                            <div class="gain-label">Jours de repos</div>
                            <div class="gain-value">${(opt.totalDays || selectedDates.length) + opt.gain}</div>
                        </div>
                        <div class="gain-item">
                            <div class="gain-label">Efficacit√©</div>
                            <div class="gain-value">${opt.efficiency || 100}%</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function applyOptimization(index) {
            updateAIMessage(`‚úÖ Optimisation appliqu√©e ! Consultez le calendrier pour voir les modifications.`, 'success');
        }

        // Fonction pour appliquer une suggestion sur le calendrier
        function applySuggestion(startStr, endStr, dates) {
            // Ajouter la p√©riode aux p√©riodes en attente
            const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
            const start = new Date(startStr);
            const end = new Date(endStr);
            const reprise = new Date(end);
            reprise.setDate(reprise.getDate() + 1);
            const lastOuvrable = getLastOuvrableBefore(reprise, weeklyRestDay);
            const workDays = countOuvrables(start, lastOuvrable, weeklyRestDay);

            pendingPeriods.push({
                start: startStr,
                end: endStr,
                lastOuvrable: formatDate(lastOuvrable),
                dates: dates,
                jours: workDays
            });

            // Retirer cette suggestion de la liste (mais garder les autres)
            suggestedPeriods = suggestedPeriods.filter(s =>
                !(s.start === startStr && s.end === endStr)
            );

            // Si plus de suggestions, cacher l'info
            if (suggestedPeriods.length === 0) {
                document.getElementById('suggestionsInfo').style.display = 'none';
                document.getElementById('clearSuggestionsBtn').style.display = 'none';
            }

            // Naviguer vers le mois de la p√©riode
            currentDate = new Date(start);
            renderCalendar();
            updateSelectionInfo();

            updateAIMessage(`‚úÖ P√©riode sugg√©r√©e ajout√©e √† votre planning ! Du ${formatDisplayDate(startStr)} au ${formatDisplayDate(endStr)} (${workDays} jours ouvrables).`, 'success');
        }

        // ===== PLANIFICATION ANNUELLE =====
        function suggestBridges() {
            const currentYear = new Date().getFullYear();
            const bridges = [];

            JOURS_FERIES_2025.forEach(holiday => {
                const holidayDate = new Date(holiday.date);
                const dayOfWeek = holidayDate.getDay();

                if (dayOfWeek === 4) { // Jeudi
                    const friday = new Date(holidayDate);
                    friday.setDate(friday.getDate() + 1);
                    const startDate = formatDate(holidayDate);
                    const endDate = formatDate(friday);

                    // G√©n√©rer les dates
                    const dates = [];
                    let current = new Date(holidayDate);
                    while (current <= friday) {
                        dates.push(formatDate(current));
                        current.setDate(current.getDate() + 1);
                    }

                    bridges.push({
                        name: holiday.nom,
                        date: holidayDate,
                        start: startDate,
                        end: endDate,
                        dates: dates,
                        suggestion: `Prenez le ${formatDisplayDate(startDate)} pour avoir 4 jours de repos (jeudi + vendredi + weekend)`,
                        daysNeeded: 1,
                        totalDays: 4
                    });
                } else if (dayOfWeek === 2) { // Mardi
                    const monday = new Date(holidayDate);
                    monday.setDate(monday.getDate() - 1);
                    const startDate = formatDate(monday);
                    const endDate = formatDate(holidayDate);

                    // G√©n√©rer les dates
                    const dates = [];
                    let current = new Date(monday);
                    while (current <= holidayDate) {
                        dates.push(formatDate(current));
                        current.setDate(current.getDate() + 1);
                    }

                    bridges.push({
                        name: holiday.nom,
                        date: holidayDate,
                        start: startDate,
                        end: endDate,
                        dates: dates,
                        suggestion: `Prenez le ${formatDisplayDate(startDate)} pour avoir 4 jours de repos (lundi + mardi + weekend)`,
                        daysNeeded: 1,
                        totalDays: 4
                    });
                }
            });

            if (bridges.length === 0) {
                updateAIMessage('‚ÑπÔ∏è Aucun pont optimal d√©tect√© pour cette ann√©e. Les jours f√©ri√©s ne tombent pas sur des jeudis ou mardis.', 'info');
                return;
            }

            // Afficher les suggestions sur le calendrier
            suggestedPeriods = bridges.map(bridge => ({
                start: bridge.start,
                end: bridge.end,
                dates: bridge.dates,
                type: 'bridge',
                name: bridge.name
            }));

            // Afficher l'info et le bouton pour effacer
            document.getElementById('suggestionsInfo').style.display = 'block';
            document.getElementById('clearSuggestionsBtn').style.display = 'inline-flex';

            // Naviguer vers le premier pont
            if (bridges.length > 0) {
                const firstBridge = bridges[0];
                currentDate = new Date(firstBridge.date);
                renderCalendar();
            }

            let message = `üåâ <strong>Meilleurs ponts de l'ann√©e ${currentYear} :</strong><br><br>`;
            bridges.forEach((bridge, index) => {
                message += `${index + 1}. <strong>${bridge.name}</strong> (${formatDisplayDate(bridge.start)} ‚Üí ${formatDisplayDate(bridge.end)})<br>`;
                message += `   ${bridge.suggestion}<br>`;
                message += `   ‚Üí Gain : ${bridge.totalDays} jours de repos pour ${bridge.daysNeeded} jour de cong√©<br><br>`;
            });
            message += `üí° <em>Les p√©riodes sugg√©r√©es sont maintenant visibles sur le calendrier en jaune/orange. Cliquez sur une p√©riode pour l'ajouter √† votre planning.</em>`;

            updateAIMessage(message, 'success');

            // Ajouter des suggestions pour appliquer chaque pont
            bridges.forEach((bridge, index) => {
                addAISuggestion(
                    `Appliquer le pont de ${bridge.name}`,
                    `S√©lectionner la p√©riode du ${formatDisplayDate(bridge.start)} au ${formatDisplayDate(bridge.end)}`,
                    () => applySuggestion(bridge.start, bridge.end, bridge.dates)
                );
            });
        }

        function suggestSummerPeriod() {
            const today = new Date();
            const currentYear = today.getFullYear();

            // Sugg√©rer une p√©riode estivale de 12 jours minimum
            const suggestedStart = new Date(currentYear, 4, 15); // 15 mai
            const suggestedEnd = new Date(currentYear, 4, 26); // 26 mai (12 jours ouvrables)
            const startStr = formatDate(suggestedStart);
            const endStr = formatDate(suggestedEnd);

            // G√©n√©rer toutes les dates
            const dates = [];
            let current = new Date(suggestedStart);
            while (current <= suggestedEnd) {
                dates.push(formatDate(current));
                current.setDate(current.getDate() + 1);
            }

            const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
            const lastOuvrable = getLastOuvrableBefore(new Date(suggestedEnd.getTime() + 86400000), weeklyRestDay);
            const workDays = countOuvrables(suggestedStart, lastOuvrable, weeklyRestDay);

            // Afficher la suggestion sur le calendrier
            suggestedPeriods = [{
                start: startStr,
                end: endStr,
                dates: dates,
                type: 'summer',
                name: 'P√©riode estivale optimale'
            }];

            // Afficher l'info et le bouton pour effacer
            document.getElementById('suggestionsInfo').style.display = 'block';
            document.getElementById('clearSuggestionsBtn').style.display = 'inline-flex';

            // Naviguer vers le mois de mai
            currentDate = new Date(suggestedStart);
            renderCalendar();

            let message = `‚òÄÔ∏è <strong>Suggestion de p√©riode estivale pour le fractionnement :</strong><br><br>`;
            message += `üìÖ <strong>P√©riode recommand√©e :</strong> Du ${formatDisplayDate(startStr)} au ${formatDisplayDate(endStr)}<br>`;
            message += `üìä <strong>Jours ouvrables :</strong> ${workDays} jours<br><br>`;
            message += `‚úÖ Cette p√©riode vous permet de :<br>`;
            message += `‚Ä¢ Respecter la condition des 12 jours continus en √©t√© (mai-octobre)<br>`;
            message += `‚Ä¢ √ätre √©ligible au fractionnement si vous gardez 3-6 jours du principal pour l'hiver<br>`;
            message += `‚Ä¢ Profiter d'une belle p√©riode estivale<br><br>`;
            message += `üí° <em>La p√©riode sugg√©r√©e est maintenant visible sur le calendrier en jaune/orange. Cliquez sur "Appliquer cette suggestion" pour l'ajouter √† votre planning.</em>`;

            updateAIMessage(message, 'success');

            addAISuggestion(
                'Appliquer cette suggestion',
                `S√©lectionner la p√©riode du ${formatDisplayDate(startStr)} au ${formatDisplayDate(endStr)}`,
                () => applySuggestion(startStr, endStr, dates)
            );
        }

        function suggestWinterPeriod() {
            const today = new Date();
            const currentYear = today.getFullYear();

            // Sugg√©rer une p√©riode hivernale de 3-6 jours
            const suggestedStart = new Date(currentYear, 11, 23); // 23 d√©cembre
            const suggestedEnd = new Date(currentYear, 11, 27); // 27 d√©cembre
            const startStr = formatDate(suggestedStart);
            const endStr = formatDate(suggestedEnd);

            // G√©n√©rer toutes les dates
            const dates = [];
            let current = new Date(suggestedStart);
            while (current <= suggestedEnd) {
                dates.push(formatDate(current));
                current.setDate(current.getDate() + 1);
            }

            const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
            const lastOuvrable = getLastOuvrableBefore(new Date(suggestedEnd.getTime() + 86400000), weeklyRestDay);
            const workDays = countOuvrables(suggestedStart, lastOuvrable, weeklyRestDay);

            // Afficher la suggestion sur le calendrier
            suggestedPeriods = [{
                start: startStr,
                end: endStr,
                dates: dates,
                type: 'winter',
                name: 'P√©riode hivernale optimale'
            }];

            // Afficher l'info et le bouton pour effacer
            document.getElementById('suggestionsInfo').style.display = 'block';
            document.getElementById('clearSuggestionsBtn').style.display = 'inline-flex';

            // Naviguer vers le mois de d√©cembre
            currentDate = new Date(suggestedStart);
            renderCalendar();

            let message = `‚ùÑÔ∏è <strong>Suggestion de p√©riode hivernale pour optimiser le fractionnement :</strong><br><br>`;
            message += `üìÖ <strong>P√©riode recommand√©e :</strong> Du ${formatDisplayDate(startStr)} au ${formatDisplayDate(endStr)}<br>`;
            message += `üìä <strong>Jours ouvrables :</strong> ${workDays} jours<br><br>`;
            message += `‚úÖ Cette p√©riode vous permet de :<br>`;
            message += `‚Ä¢ Utiliser 3-6 jours du principal en p√©riode hivernale (novembre-avril)<br>`;
            message += `‚Ä¢ Obtenir +2 jours de fractionnement si vous avez 6 jours ou +1 jour si vous avez 3 jours<br>`;
            message += `‚Ä¢ Profiter des f√™tes de fin d'ann√©e<br><br>`;
            message += `üí° <em>La p√©riode sugg√©r√©e est maintenant visible sur le calendrier en jaune/orange. Cliquez sur "Appliquer cette suggestion" pour l'ajouter √† votre planning.</em>`;

            updateAIMessage(message, 'success');

            addAISuggestion(
                'Appliquer cette suggestion',
                `S√©lectionner la p√©riode du ${formatDisplayDate(startStr)} au ${formatDisplayDate(endStr)}`,
                () => applySuggestion(startStr, endStr, dates)
            );
        }

        function generateYearlyPlan() {
            const annualRights = parseInt(document.getElementById('annualRights').value) || 30;
            const totalDays = currentBalance.principal + currentBalance.cinquieme +
                currentBalance.fractionnement + currentBalance.anciennete +
                currentBalance.enfant + currentBalance.report;

            let message = `üìä <strong>Plan d'optimisation annuel personnalis√© :</strong><br><br>`;
            message += `üìà <strong>Votre situation actuelle :</strong><br>`;
            message += `‚Ä¢ Total de jours disponibles : ${totalDays} jours<br>`;
            message += `‚Ä¢ Principal : ${currentBalance.principal} jours<br>`;
            message += `‚Ä¢ 5√®me semaine : ${currentBalance.cinquieme} jours<br>`;
            message += `‚Ä¢ Fractionnement actuel : ${currentBalance.fractionnement} jours<br><br>`;

            message += `üéØ <strong>Strat√©gie recommand√©e :</strong><br>`;
            message += `1. <strong>P√©riode estivale (Mai-Octobre) :</strong><br>`;
            message += `   ‚Üí Prenez au moins 12 jours continus du principal en √©t√©<br>`;
            message += `   ‚Üí Id√©alement 18-20 jours pour profiter pleinement<br><br>`;

            message += `2. <strong>P√©riode hivernale (Novembre-Avril) :</strong><br>`;
            message += `   ‚Üí R√©servez 6 jours du principal pour l'hiver<br>`;
            message += `   ‚Üí Cela vous donnera +2 jours de fractionnement<br><br>`;

            message += `3. <strong>Optimisation des ponts :</strong><br>`;
            message += `   ‚Üí Utilisez les ponts pour maximiser vos weekends<br>`;
            message += `   ‚Üí 1 jour de cong√© peut donner 4 jours de repos<br><br>`;

            const potentialGain = 2; // Fractionnement maximum
            message += `üí∞ <strong>Gain potentiel :</strong> +${potentialGain} jours de fractionnement si vous suivez cette strat√©gie !<br><br>`;

            message += `üí° <em>Utilisez les suggestions ci-dessus pour planifier vos p√©riodes sp√©cifiques.</em>`;

            updateAIMessage(message, 'success');

            // Analyser l'historique existant
            if (leaveHistory.length > 0) {
                let totalTaken = 0;
                let summerTaken = 0;
                let winterTaken = 0;

                leaveHistory.forEach(leave => {
                    totalTaken += leave.jours;
                    const start = new Date(leave.debut);
                    const month = start.getMonth();
                    if (month >= 4 && month <= 9) {
                        summerTaken += leave.jours;
                    } else {
                        winterTaken += leave.jours;
                    }
                });

                addAISuggestion(
                    'Analyse de votre historique',
                    `Vous avez d√©j√† pris ${totalTaken} jours (${summerTaken} en √©t√©, ${winterTaken} en hiver). Cliquez pour une analyse d√©taill√©e.`,
                    () => analyzeHistory()
                );
            }
        }

        // ===== BALANCE =====
        function calculateBalance() {
            // Recalculer l'anciennet√© d'abord
            const ancienneteDays = calculateSeniorityDays();
            document.getElementById('anciennete').value = ancienneteDays;

            currentBalance = {
                anciennete: ancienneteDays,
                enfant: parseInt(document.getElementById('enfant').value) || 0,
                report: parseInt(document.getElementById('report').value) || 0,
                cinquieme: parseInt(document.getElementById('cinquieme').value) || 6,
                fractionnement: parseInt(document.getElementById('fractionnement').value) || 0,
                principal: 24
            };

            // Recalculer le fractionnement depuis l'historique
            const fractionnement = calculateFractionnementFromHistory();
            currentBalance.fractionnement = fractionnement;
            document.getElementById('fractionnement').value = fractionnement;

            document.getElementById('balancePrincipal').textContent = currentBalance.principal;
            document.getElementById('balanceCinquieme').textContent = currentBalance.cinquieme;
            document.getElementById('balanceFractionnement').textContent = currentBalance.fractionnement;
            document.getElementById('balanceAnciennete').textContent = currentBalance.anciennete;
            document.getElementById('balanceEnfant').textContent = currentBalance.enfant;
            document.getElementById('balanceReport').textContent = currentBalance.report;

            const total = currentBalance.principal + currentBalance.cinquieme +
                currentBalance.fractionnement + currentBalance.anciennete +
                currentBalance.enfant + currentBalance.report;

            updateAIMessage(`‚úÖ Solde recalcul√© ! Vous avez <strong>${total} jours ouvrables</strong> disponibles au total.`, 'success');
        }

        // ===== SIMULATION =====
        function runSimulation() {
            const startDate = document.getElementById('simStartDate').value;
            const endDate = document.getElementById('simEndDate').value;

            if (!startDate || !endDate) {
                updateAIMessage('‚ùå Veuillez renseigner les dates de d√©but et de fin.', 'error');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (end < start) {
                updateAIMessage('‚ùå La date de fin doit √™tre apr√®s la date de d√©but.', 'error');
                return;
            }

            const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
            const reprise = new Date(end);
            reprise.setDate(reprise.getDate() + 1);

            const lastOuvrable = getLastOuvrableBefore(reprise, weeklyRestDay);
            const daysNeeded = countOuvrables(start, lastOuvrable, weeklyRestDay);

            const result = imputeDays(currentBalance, daysNeeded);

            let html = `
                <div class="simulation-result">
                    <h4 style="color: var(--vinci-blue); margin-bottom: 15px;">üìä R√©sultat de la Simulation</h4>
                    <div class="result-item">
                        <span><strong>P√©riode :</strong></span>
                        <span>${formatDisplayDate(startDate)} ‚Üí ${formatDisplayDate(endDate)}</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Jours ouvrables :</strong></span>
                        <span>${daysNeeded} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Dernier jour ouvrable :</strong></span>
                        <span>${formatDisplayDate(lastOuvrable.toISOString().split('T')[0])}</span>
                    </div>
                </div>

                <div class="gain-loss">
                    <div class="gain">
                        <div class="gain-label">üéØ Imputation CNETP</div>
                        <div class="gain-value">${result.totalConsumed}j</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">
                            ${Object.entries(result.consumed).filter(([k, v]) => v > 0).map(([k, v]) => `${k}: ${v}j`).join('<br>')}
                        </div>
                    </div>
                    <div class="loss">
                        <div class="loss-label">üìâ Solde apr√®s</div>
                        <div class="loss-value">${Object.values(result.remaining).reduce((a, b) => a + b, 0)}j</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">
                            Principal: ${result.remaining.principal}j<br>
                            5√®me: ${result.remaining.cinquieme}j
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('simulationResult').innerHTML = html;
            updateAIMessage(`‚úÖ Simulation termin√©e ! ${daysNeeded} jours ouvrables seront consomm√©s.`, 'success');
        }

        // ===== HISTORIQUE =====
        function addLeavePeriod() {
            const startDate = document.getElementById('newLeaveStart').value;
            const endDate = document.getElementById('newLeaveEnd').value;
            const manualDays = document.getElementById('newLeaveDays').value;

            if (!startDate || !endDate) {
                updateAIMessage('‚ùå Veuillez renseigner les dates de d√©but et de fin.', 'error');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (end < start) {
                updateAIMessage('‚ùå La date de fin doit √™tre apr√®s la date de d√©but.', 'error');
                return;
            }

            // Validation : d√©lai minimum de 1 mois entre p√©riodes
            const validationError = validatePeriodGap(start, end);
            if (validationError) {
                updateAIMessage(validationError, 'error');
                return;
            }

            // Validation : pas de demi-journ√©es autoris√©es (r√®gle entreprise)
            if (manualDays) {
                const daysValue = parseFloat(manualDays);
                if (isNaN(daysValue) || daysValue < 0) {
                    updateAIMessage('‚ùå Le nombre de jours doit √™tre un nombre positif.', 'error');
                    return;
                }
                if (daysValue % 1 !== 0) {
                    updateAIMessage('‚ùå <strong>R√®gle entreprise :</strong> Les demi-journ√©es de cong√©s pay√©s ne sont plus autoris√©es. Veuillez saisir un nombre entier de jours.', 'error');
                    return;
                }
            }

            const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
            const reprise = new Date(end);
            reprise.setDate(reprise.getDate() + 1);

            // Le dernier jour de cong√© est le dernier jour ouvrable avant la reprise
            const lastOuvrable = getLastOuvrableBefore(reprise, weeklyRestDay);
            const calculatedDays = manualDays ? parseInt(manualDays) : countOuvrables(start, lastOuvrable, weeklyRestDay);

            // V√©rifier que le nombre calcul√© est un entier (pas de demi-journ√©e)
            if (calculatedDays % 1 !== 0) {
                updateAIMessage('‚ùå <strong>R√®gle entreprise :</strong> Les demi-journ√©es de cong√©s pay√©s ne sont plus autoris√©es. Le calcul a g√©n√©r√© un nombre d√©cimal, ce qui n\'est pas autoris√©.', 'error');
                return;
            }

            // G√©n√©rer les dates de la p√©riode (du d√©but au dernier jour ouvrable r√©el)
            const dates = [];
            let current = new Date(start);
            const lastOuvrableDate = new Date(lastOuvrable);
            while (current <= lastOuvrableDate) {
                dates.push(formatDate(current));
                current.setDate(current.getDate() + 1);
            }

            // R√®gle CNETP : stocker le dernier jour ouvrable r√©el, pas la date de fin s√©lectionn√©e
            const lastOuvrableStr = formatDate(lastOuvrable);
            leaveHistory.push({
                debut: startDate,
                fin: lastOuvrableStr, // Utiliser le dernier jour ouvrable r√©el
                finSelectionnee: endDate, // Garder la date s√©lectionn√©e pour r√©f√©rence
                jours: calculatedDays,
                dates: dates
            });

            renderHistoryTable();
            renderCalendar();
            updateStats();
            calculateBalance(); // Recalculer le solde avec le fractionnement mis √† jour
            autoSave(); // Sauvegarder

            document.getElementById('newLeaveStart').value = '';
            document.getElementById('newLeaveEnd').value = '';
            document.getElementById('newLeaveDays').value = '';

            updateAIMessage(`‚úÖ P√©riode ajout√©e ! ${calculatedDays} jours ouvrables enregistr√©s (dernier jour ouvrable: ${formatDisplayDate(formatDate(lastOuvrable))}).`, 'success');
        }

        function renderHistoryTable() {
            const container = document.getElementById('historyTableContainer');

            if (leaveHistory.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--text-light); text-align: center; padding: 20px;">
                        Aucune p√©riode de cong√© enregistr√©e. Ajoutez votre premi√®re p√©riode.
                    </p>
                `;
                document.getElementById('analyzeBtn').style.display = 'none';
                document.getElementById('clearBtn').style.display = 'none';
                document.getElementById('exportBtn').style.display = 'none';
                return;
            }

            let html = `
                <div class="table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date d√©but</th>
                                <th>Date fin</th>
                                <th>Jours</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            leaveHistory.forEach((leave, index) => {
                html += `
                    <tr>
                        <td>${formatDisplayDate(leave.debut)}</td>
                        <td>${formatDisplayDate(leave.fin)}</td>
                        <td><strong>${leave.jours}</strong> jours</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeLeave(${index})" style="padding: 6px 12px; font-size: 0.85rem;">
                                üóëÔ∏è Supprimer
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;

            document.getElementById('analyzeBtn').style.display = 'inline-flex';
            document.getElementById('clearBtn').style.display = 'inline-flex';
            document.getElementById('exportBtn').style.display = 'inline-flex';
        }

        function removeLeave(index) {
            leaveHistory.splice(index, 1);
            renderHistoryTable();
            renderCalendar();
            updateStats();
            calculateBalance();
            autoSave(); // Sauvegarder
            updateAIMessage('‚úÖ P√©riode supprim√©e de l\'historique.', 'success');
        }

        function clearHistory() {
            if (!confirm('√ätes-vous s√ªr de vouloir effacer tout l\'historique ?')) return;

            leaveHistory = [];
            renderHistoryTable();
            renderCalendar();
            updateStats();
            calculateBalance();
            autoSave(); // Sauvegarder
            updateAIMessage('‚úÖ Historique effac√©.', 'success');
        }

        function importHistory() {
            const input = document.getElementById('historyInput').value.trim();
            if (!input) {
                updateAIMessage('‚ùå Veuillez coller du JSON valide.', 'error');
                return;
            }

            try {
                const data = JSON.parse(input);
                if (!Array.isArray(data)) {
                    throw new Error('Le JSON doit √™tre un tableau');
                }

                // Validation : v√©rifier qu'il n'y a pas de demi-journ√©es (r√®gle entreprise)
                for (const item of data) {
                    if (item.jours !== undefined && item.jours !== null) {
                        const jours = parseFloat(item.jours);
                        if (isNaN(jours) || jours < 0) {
                            throw new Error(`Le nombre de jours doit √™tre un nombre positif. P√©riode : ${item.debut} ‚Üí ${item.fin}`);
                        }
                        if (jours % 1 !== 0) {
                            throw new Error(`R√®gle entreprise : Les demi-journ√©es de cong√©s pay√©s ne sont plus autoris√©es. P√©riode : ${item.debut} ‚Üí ${item.fin} (${jours} jours)`);
                        }
                    }
                }

                leaveHistory = data.map(item => {
                    const dates = [];
                    let current = new Date(item.debut);
                    const end = new Date(item.fin);
                    while (current <= end) {
                        dates.push(formatDate(current));
                        current.setDate(current.getDate() + 1);
                    }
                    return {
                        ...item,
                        dates: dates
                    };
                });

                renderHistoryTable();
                renderCalendar();
                updateStats();
                calculateBalance();
                autoSave(); // Sauvegarder
                updateAIMessage(`‚úÖ ${leaveHistory.length} p√©riode(s) import√©e(s) !`, 'success');
            } catch (e) {
                updateAIMessage(`‚ùå Erreur JSON : ${e.message}`, 'error');
            }
        }

        function exportHistory() {
            const json = JSON.stringify(leaveHistory.map(l => ({
                debut: l.debut,
                fin: l.fin,
                jours: l.jours
            })), null, 2);

            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'historique-conges.json';
            a.click();

            updateAIMessage('‚úÖ Historique export√© en JSON !', 'success');
        }

        function analyzeHistory() {
            if (leaveHistory.length === 0) {
                updateAIMessage('‚ùå Veuillez d\'abord ajouter des p√©riodes √† votre historique.', 'error');
                return;
            }

            let totalDays = 0;
            let summerDays = 0;
            let winterDays = 0;

            // R√®gle CNETP : S√©parer le cong√© principal (24 jours) de la 5√®me semaine (6 jours)
            // Cong√© principal = 24 premiers jours ouvrables (jours 1 √† 24)
            // 5√®me semaine = 6 jours ouvrables (jours 25 √† 30)
            // Le fractionnement se calcule UNIQUEMENT sur les 24 premiers jours (cong√© principal)

            let principalDaysTaken = 0;
            let principalDaysInSummer = 0;
            let principalDaysInWinter = 0;
            let maxContinuousPrincipalSummer = 0;
            let has12ContinuousPrincipalSummer = false;

            // Trier les p√©riodes par date
            const sortedLeaves = [...leaveHistory].sort((a, b) =>
                new Date(a.debut) - new Date(b.debut)
            );

            // Simuler l'imputation CNETP pour s√©parer principal (24 jours) de 5√®me semaine (6 jours)
            // Ordre d'imputation : anciennet√©, enfant, report, 5√®me semaine, fractionnement, principal
            let remainingRights = {
                anciennete: parseInt(document.getElementById('anciennete').value) || 0,
                enfant: parseInt(document.getElementById('enfant').value) || 0,
                report: parseInt(document.getElementById('report').value) || 0,
                cinquieme: parseInt(document.getElementById('cinquieme').value) || 6,
                fractionnement: 0, // Calcul√© apr√®s, donc 0 pour cette simulation
                principal: 24 // 24 premiers jours = cong√© principal
            };

            let currentContinuousPrincipal = 0;
            let lastEndDate = null;

            sortedLeaves.forEach(leave => {
                totalDays += leave.jours;
                const start = new Date(leave.debut);
                const month = start.getMonth();
                const end = new Date(leave.fin);

                // Simuler l'imputation CNETP
                // L'ordre d'imputation garantit que les 24 premiers jours sont du principal
                // et que les 6 jours suivants sont de la 5√®me semaine
                const result = imputeDays(remainingRights, leave.jours);
                remainingRights = result.remaining;

                // Compter UNIQUEMENT les jours du principal (24 premiers jours)
                // Exclure explicitement la 5√®me semaine (result.consumed.CINQUIEME)
                const principalConsumed = result.consumed.PRINCIPAL;
                principalDaysTaken += principalConsumed;

                if (month >= 4 && month <= 9) {
                    summerDays += leave.jours;
                    principalDaysInSummer += principalConsumed;

                    // V√©rifier la continuit√© pour les jours du principal uniquement
                    if (lastEndDate && start > lastEndDate) {
                        // Gap d√©tect√©, r√©initialiser
                        currentContinuousPrincipal = 0;
                    }
                    currentContinuousPrincipal += principalConsumed;
                    if (currentContinuousPrincipal > maxContinuousPrincipalSummer) {
                        maxContinuousPrincipalSummer = currentContinuousPrincipal;
                    }
                    if (currentContinuousPrincipal >= 12) {
                        has12ContinuousPrincipalSummer = true;
                    }
                } else {
                    winterDays += leave.jours;
                    principalDaysInWinter += principalConsumed;
                    currentContinuousPrincipal = 0; // R√©initialiser car on sort de l'√©t√©
                }

                lastEndDate = end;
            });

            const annualRights = parseInt(document.getElementById('annualRights').value) || 30;
            const principalRemaining = 24 - principalDaysTaken;

            const fractionnement = calculateFractionnement({
                principalDaysTakenSummer: principalDaysInSummer,
                principalDaysTakenWinter: principalDaysInWinter,
                isContinuous12Summer: has12ContinuousPrincipalSummer,
                allLeavesInWinter: principalDaysInSummer === 0 && principalDaysInWinter > 0
            });

            let analysis = `
                <div class="analysis-box">
                    <h4>üß† Analyse IA de votre historique</h4>
                    <div class="result-item">
                        <span><strong>Total jours pris :</strong></span>
                        <span>${totalDays} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Jours en √©t√© (Mai-Oct) :</strong></span>
                        <span>${summerDays} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Jours en hiver (Nov-Avr) :</strong></span>
                        <span>${winterDays} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Jours du principal en √©t√© :</strong></span>
                        <span>${principalDaysInSummer} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Jours du principal en hiver :</strong></span>
                        <span>${principalDaysInWinter} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Plus longue p√©riode continue du principal en √©t√© :</strong></span>
                        <span>${maxContinuousPrincipalSummer} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>12 jours continus du principal en √©t√© :</strong></span>
                        <span>${has12ContinuousPrincipalSummer ? '‚úÖ Oui' : '‚ùå Non'}</span>
                    </div>
                </div>

                <div class="gain-loss">
                    <div class="gain">
                        <div class="gain-label">üéÅ Fractionnement estim√©</div>
                        <div class="gain-value">+${fractionnement} jour(s)</div>
                    </div>
                    <div class="loss">
                        <div class="loss-label">üìä Solde principal restant</div>
                        <div class="loss-value">${principalRemaining} jours</div>
                    </div>
                </div>

                <div class="tip-box">
                    <strong>üí° Recommandations de l'IA :</strong><br>
            `;

            // Messages selon les r√®gles CNETP officielles
            if (!has12ContinuousPrincipalSummer) {
                analysis += `‚ö†Ô∏è <strong>Condition 1 non remplie :</strong> Vous n'avez pas pris 12 jours continus du principal en √©t√©. Pour √™tre √©ligible au fractionnement, vous devez prendre au moins 12 jours continus du principal (sur les 24 premiers jours, pas la 5√®me semaine) entre le 1er mai et le 31 octobre.<br>`;
            } else {
                analysis += `‚úÖ <strong>Condition 1 remplie :</strong> Vous avez pris 12 jours continus du principal en √©t√©.<br>`;
            }

            // Condition 2 : Maximum de jours en √©t√©
            if (principalDaysInSummer > 21) {
                analysis += `‚ùå <strong>Condition 2 non remplie :</strong> Vous avez pris ${principalDaysInSummer} jours du principal en √©t√©, ce qui d√©passe le maximum de 21 jours. Pour obtenir le fractionnement, vous devez prendre au maximum 21 jours (pour +1 jour) ou 18 jours (pour +2 jours) du principal entre le 1er mai et le 31 octobre.<br>`;
            } else if (principalDaysInSummer > 18) {
                analysis += `‚ö†Ô∏è <strong>Condition 2 partielle :</strong> Vous avez pris ${principalDaysInSummer} jours du principal en √©t√©. Pour obtenir +2 jours de fractionnement, vous devez prendre au maximum 18 jours. Actuellement, vous pouvez obtenir +1 jour si vous respectez la condition 3.<br>`;
            } else {
                analysis += `‚úÖ <strong>Condition 2 remplie :</strong> Vous avez pris ${principalDaysInSummer} jours du principal en √©t√© (‚â§ 18 pour +2 jours, ‚â§ 21 pour +1 jour).<br>`;
            }

            // Condition 3 : Jours en hiver
            if (principalDaysInWinter === 6 && principalDaysInSummer <= 18) {
                analysis += `‚úÖ <strong>Condition 3 remplie :</strong> Vous avez pris exactement 6 jours du principal en hiver. Avec ${principalDaysInSummer} jours en √©t√© (‚â§ 18), vous obtenez +2 jours de fractionnement ! üéâ<br>`;
            } else if (principalDaysInWinter >= 3 && principalDaysInWinter <= 5 && principalDaysInSummer <= 21) {
                analysis += `‚úÖ <strong>Condition 3 remplie :</strong> Vous avez pris ${principalDaysInWinter} jours du principal en hiver (entre 3 et 5). Avec ${principalDaysInSummer} jours en √©t√© (‚â§ 21), vous obtenez +1 jour de fractionnement ! üéâ<br>`;
            } else if (principalDaysInWinter < 3) {
                analysis += `‚ùå <strong>Condition 3 non remplie :</strong> Vous avez pris ${principalDaysInWinter} jour(s) du principal en hiver. Pour obtenir le fractionnement, vous devez prendre 3 √† 5 jours (pour +1 jour) ou exactement 6 jours (pour +2 jours) du principal entre le 1er novembre et le 30 avril.<br>`;
            } else if (principalDaysInWinter > 5 && principalDaysInWinter !== 6) {
                analysis += `‚ùå <strong>Condition 3 non remplie :</strong> Vous avez pris ${principalDaysInWinter} jours du principal en hiver. Pour obtenir le fractionnement, vous devez prendre 3 √† 5 jours (pour +1 jour) ou exactement 6 jours (pour +2 jours) du principal entre le 1er novembre et le 30 avril.<br>`;
            } else {
                analysis += `üí° <strong>Condition 3 :</strong> Vous avez pris ${principalDaysInWinter} jours du principal en hiver. Pour optimiser, prenez 3 √† 5 jours (pour +1 jour) ou exactement 6 jours (pour +2 jours) du principal entre le 1er novembre et le 30 avril.<br>`;
            }

            if (fractionnement === 0) {
                analysis += `<br>üìå <strong>R√©sum√© :</strong> Vous ne remplissez pas encore toutes les conditions pour obtenir le fractionnement. V√©rifiez les 3 conditions ci-dessus et optimisez votre planning !<br>`;
            }

            analysis += `</div>`;

            const container = document.getElementById('historyTableContainer');
            const oldAnalysis = container.querySelector('.analysis-box');
            if (oldAnalysis) {
                oldAnalysis.remove();
            }
            container.insertAdjacentHTML('beforeend', analysis);
            updateAIMessage(`‚úÖ Analyse termin√©e ! ${fractionnement > 0 ? `Vous b√©n√©ficiez de ${fractionnement} jour(s) de fractionnement. üéâ` : 'Optimisez votre planning pour obtenir le fractionnement.'}`, 'success');
        }

        // ===== AUDIT =====
        function runAudit() {
            if (leaveHistory.length === 0) {
                updateAIMessage('‚ùå Veuillez d\'abord ajouter des p√©riodes de cong√© √† votre historique pour l\'audit.', 'error');
                return;
            }

            const container = document.getElementById('auditResults');
            let issues = [];
            let warnings = [];
            let totalCalculated = 0;

            leaveHistory.forEach((leave, index) => {
                const start = new Date(leave.debut);
                // Utiliser finSelectionnee si elle existe (pour compatibilit√© avec anciennes donn√©es)
                // Sinon utiliser fin (qui devrait √™tre le dernier jour ouvrable r√©el)
                const endDateStr = leave.finSelectionnee || leave.fin;
                const end = new Date(endDateStr);

                // Calculer la date de reprise (jour suivant la fin s√©lectionn√©e)
                const reprise = new Date(end);
                reprise.setDate(reprise.getDate() + 1);

                // R√®gle CNETP : calculer le dernier jour ouvrable r√©el avant la reprise
                const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
                const lastOuvrable = getLastOuvrableBefore(reprise, weeklyRestDay);
                const calculatedDays = countOuvrables(start, lastOuvrable, weeklyRestDay);
                totalCalculated += calculatedDays;

                // V√©rifier et corriger si n√©cessaire : leave.fin doit √™tre le dernier jour ouvrable r√©el
                const lastOuvrableStr = formatDate(lastOuvrable);
                if (leave.fin !== lastOuvrableStr) {
                    // Corriger automatiquement la date de fin pour qu'elle soit le dernier jour ouvrable r√©el
                    leave.fin = lastOuvrableStr;
                    if (!leave.finSelectionnee) {
                        // Si finSelectionnee n'existe pas, la cr√©er avec l'ancienne valeur de fin
                        leave.finSelectionnee = endDateStr;
                    }
                }

                if (leave.jours) {
                    const diff = Math.abs(calculatedDays - leave.jours);
                    if (diff > 0) {
                        issues.push({
                            period: `${leave.debut} ‚Üí ${leave.fin}`,
                            declared: leave.jours,
                            calculated: calculatedDays,
                            diff: diff
                        });
                    }
                } else {
                    warnings.push({
                        period: `${leave.debut} ‚Üí ${leave.fin}`,
                        calculated: calculatedDays
                    });
                }
            });

            let html = '';

            if (issues.length === 0 && warnings.length === 0) {
                html = `
                    <div class="audit-alert success">
                        <span style="font-size: 1.5rem;">‚úÖ</span>
                        <div>
                            <strong>Audit r√©ussi !</strong><br>
                            Aucune erreur d√©tect√©e dans votre d√©compte. Total calcul√© : ${totalCalculated} jours ouvrables.
                        </div>
                    </div>
                `;
            } else {
                if (issues.length > 0) {
                    html += `
                        <div class="audit-alert error">
                            <span style="font-size: 1.5rem;">‚ùå</span>
                            <div>
                                <strong>${issues.length} erreur(s) d√©tect√©e(s) :</strong><br>
                                <ul style="margin-top: 10px; margin-left: 20px;">
                    `;
                    issues.forEach(issue => {
                        html += `<li>P√©riode ${issue.period} : D√©clar√© ${issue.declared} jours, Calcul√© ${issue.calculated} jours (diff√©rence: ${issue.diff} jour(s))</li>`;
                    });
                    html += `</ul></div></div>`;
                }

                if (warnings.length > 0) {
                    html += `
                        <div class="audit-alert warning">
                            <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                            <div>
                                <strong>${warnings.length} p√©riode(s) sans nombre de jours d√©clar√© :</strong><br>
                                <ul style="margin-top: 10px; margin-left: 20px;">
                    `;
                    warnings.forEach(warning => {
                        html += `<li>P√©riode ${warning.period} : Calcul√© ${warning.calculated} jours ouvrables</li>`;
                    });
                    html += `</ul></div></div>`;
                }
            }

            html += `
                <div class="analysis-box" style="margin-top: 20px;">
                    <h4>üìä R√©sum√© de l'audit</h4>
                    <div class="result-item">
                        <span><strong>Total jours calcul√©s :</strong></span>
                        <span>${totalCalculated} jours ouvrables</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Erreurs d√©tect√©es :</strong></span>
                        <span>${issues.length}</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Avertissements :</strong></span>
                        <span>${warnings.length}</span>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            updateAIMessage(`üîç Audit termin√© ! ${issues.length} erreur(s) d√©tect√©e(s), ${warnings.length} avertissement(s).`, issues.length > 0 ? 'error' : 'warning');
        }

        // ===== UTILITAIRES =====
        function updateStats() {
            const fractionnement = calculateFractionnementFromHistory();
            document.getElementById('fractionnement').value = fractionnement;
            currentBalance.fractionnement = fractionnement;

            document.getElementById('balanceFractionnement').textContent = fractionnement;
        }

        function calculateFractionnementFromHistory() {
            if (leaveHistory.length === 0) return 0;

            // R√®gle CNETP : L'imputation consomme dans l'ordre :
            // 1. Anciennet√©
            // 2. Enfant
            // 3. Report
            // 4. 5√®me semaine (6 jours)
            // 5. Fractionnement (0, 1 ou 2 jours selon les conditions)
            // 6. Principal (24 jours)
            //
            // Le fractionnement se calcule UNIQUEMENT sur les 24 premiers jours (cong√© principal)
            // Il faut donc d'abord simuler l'imputation SANS fractionnement pour savoir
            // combien de jours du principal ont √©t√© pris, puis calculer le fractionnement,
            // puis r√©imputer avec le fractionnement pour avoir le r√©sultat final.

            // Trier les p√©riodes par date
            const sortedLeaves = [...leaveHistory].sort((a, b) =>
                new Date(a.debut) - new Date(b.debut)
            );

            // √âTAPE 1 : Simuler l'imputation SANS fractionnement pour calculer le fractionnement
            let remainingRightsWithoutFractionnement = {
                anciennete: parseInt(document.getElementById('anciennete').value) || 0,
                enfant: parseInt(document.getElementById('enfant').value) || 0,
                report: parseInt(document.getElementById('report').value) || 0,
                cinquieme: parseInt(document.getElementById('cinquieme').value) || 6,
                fractionnement: 0, // Pas de fractionnement pour le calcul initial
                principal: 24
            };

            let principalDaysTaken = 0;
            let principalDaysInSummer = 0;
            let principalDaysInWinter = 0;

            // Pour chaque p√©riode, simuler l'imputation SANS fractionnement
            // pour d√©terminer combien de jours du principal ont √©t√© pris
            sortedLeaves.forEach(leave => {
                const result = imputeDays(remainingRightsWithoutFractionnement, leave.jours);
                remainingRightsWithoutFractionnement = result.remaining;

                // Compter UNIQUEMENT les jours du principal (24 premiers jours)
                // Les jours de la 5√®me semaine (CINQUIEME) ne comptent PAS pour le fractionnement
                const principalConsumed = result.consumed.PRINCIPAL;
                principalDaysTaken += principalConsumed;

                // D√©terminer si c'est en √©t√© ou hiver
                const start = new Date(leave.debut);
                const month = start.getMonth();

                if (month >= 4 && month <= 9) {
                    // P√©riode estivale (1er mai - 31 octobre)
                    principalDaysInSummer += principalConsumed;
                } else {
                    // P√©riode hivernale (1er novembre - 30 avril)
                    principalDaysInWinter += principalConsumed;
                }
            });

            // V√©rifier les 12 jours continus du principal en √©t√©
            // Il faut trouver une p√©riode continue de 12 jours ou plus du principal en √©t√©
            let has12ContinuousSummer = false;
            let maxContinuousPrincipalSummer = 0;
            let currentContinuous = 0;

            // Trier les p√©riodes estivales par date
            const summerLeaves = sortedLeaves.filter(leave => {
                const start = new Date(leave.debut);
                const month = start.getMonth();
                return month >= 4 && month <= 9;
            }).sort((a, b) => new Date(a.debut) - new Date(b.debut));

            // Simuler √† nouveau pour trouver les p√©riodes continues du principal en √©t√©
            // Toujours SANS fractionnement pour d√©terminer la continuit√© des jours du principal
            let tempRights = {
                anciennete: parseInt(document.getElementById('anciennete').value) || 0,
                enfant: parseInt(document.getElementById('enfant').value) || 0,
                report: parseInt(document.getElementById('report').value) || 0,
                cinquieme: parseInt(document.getElementById('cinquieme').value) || 6,
                fractionnement: 0, // Pas de fractionnement pour le calcul de continuit√©
                principal: 24
            };

            let lastEndDate = null;

            summerLeaves.forEach(leave => {
                const leaveStart = new Date(leave.debut);
                const leaveEnd = new Date(leave.fin);

                // V√©rifier si cette p√©riode est continue avec la pr√©c√©dente
                // Deux p√©riodes sont continues si la fin de l'une est juste avant le d√©but de l'autre
                // (avec au plus 1 jour de gap pour tenir compte des weekends/jours f√©ri√©s)
                if (lastEndDate) {
                    const daysBetween = Math.floor((leaveStart - lastEndDate) / (1000 * 60 * 60 * 24));
                    // Si plus de 2 jours entre les p√©riodes, ce n'est pas continu
                    if (daysBetween > 2) {
                        // Il y a un gap significatif, r√©initialiser le compteur
                        currentContinuous = 0;
                    }
                }

                const result = imputeDays(tempRights, leave.jours);
                tempRights = result.remaining;
                const principalConsumed = result.consumed.PRINCIPAL;

                // Ajouter UNIQUEMENT les jours du principal (24 premiers jours)
                // Exclure explicitement la 5√®me semaine (CINQUIEME) du calcul de continuit√©
                currentContinuous += principalConsumed;
                if (currentContinuous > maxContinuousPrincipalSummer) {
                    maxContinuousPrincipalSummer = currentContinuous;
                }
                if (currentContinuous >= 12) {
                    has12ContinuousSummer = true;
                }

                lastEndDate = leaveEnd;
            });

            return calculateFractionnement({
                principalDaysTakenSummer: principalDaysInSummer,
                principalDaysTakenWinter: principalDaysInWinter,
                isContinuous12Summer: has12ContinuousSummer,
                allLeavesInWinter: principalDaysInSummer === 0 && principalDaysInWinter > 0
            });
        }

        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(dateStr) {
            const date = new Date(dateStr);
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
        }

        function isHoliday(dateStr) {
            return JOURS_FERIES_2025.some(h => h.date === dateStr);
        }

        function isWeekend(date, weeklyRestDay = 0) {
            // R√®gles CNETP standard : seul le dimanche (jour 0) est non ouvrable
            // Le samedi (jour 6) est un jour ouvrable
            const day = new Date(date).getDay();
            // Toujours consid√©rer le dimanche comme weekend selon les r√®gles CNETP
            return day === 0;
        }

        function hasLeaveOnDate(dateStr) {
            return leaveHistory.some(leave => leave.dates && leave.dates.includes(dateStr));
        }

        function countWorkDaysFromDates(dates, weeklyRestDay = 0) {
            // R√®gles CNETP standard : les jours ouvrables sont du lundi au samedi (6 jours/semaine)
            // Seul le dimanche (jour 0) et les jours f√©ri√©s sont non ouvrables
            // Le samedi (jour 6) est un jour ouvrable
            return dates.filter(date => {
                const dateObj = new Date(date);
                return isOuvrable(dateObj, weeklyRestDay);
            }).length;
        }

        // ===== LOCALSTORAGE =====
        function saveToLocalStorage() {
            try {
                const data = {
                    leaveHistory: leaveHistory,
                    currentBalance: currentBalance,
                    config: {
                        annualRights: parseInt(document.getElementById('annualRights').value),
                        userCategory: document.getElementById('userCategory').value,
                        serviceYears: parseInt(document.getElementById('serviceYears').value),
                        companySeniority: parseInt(document.getElementById('companySeniority').value),
                        professionSeniority: parseInt(document.getElementById('professionSeniority').value),
                        // anciennete est calcul√©, on ne le sauvegarde pas forc√©ment comme config brute mais c'est ok de le garder pour cache
                        anciennete: parseInt(document.getElementById('anciennete').value),
                        enfant: parseInt(document.getElementById('enfant').value),
                        report: parseInt(document.getElementById('report').value),
                        cinquieme: parseInt(document.getElementById('cinquieme').value),
                        weeklyRestDay: parseInt(document.getElementById('weeklyRestDay').value)
                    }, lastSaved: new Date().toISOString()
                };
                localStorage.setItem('congesIA_data', JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('Erreur lors de la sauvegarde:', e);
                return false;
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('congesIA_data');
                if (!saved) return false;

                const data = JSON.parse(saved);

                // Restaurer l'historique
                if (data.leaveHistory && Array.isArray(data.leaveHistory)) {
                    leaveHistory = data.leaveHistory;
                }

                // Restaurer le solde
                if (data.currentBalance) {
                    currentBalance = data.currentBalance;
                }

                // Restaurer les champs de formulaire
                // Configuration
                document.getElementById('annualRights').value = data.config.annualRights || 30;
                document.getElementById('userCategory').value = data.config.userCategory || 'ouvrier';
                document.getElementById('serviceYears').value = data.config.serviceYears || 0;
                document.getElementById('companySeniority').value = data.config.companySeniority || 0;
                document.getElementById('professionSeniority').value = data.config.professionSeniority || 0;

                // Initialiser l'affichage des inputs
                toggleSeniorityInputs();

                // Recalculer l'anciennet√©
                const ancienneteDays = calculateSeniorityDays();
                document.getElementById('anciennete').value = ancienneteDays;

                document.getElementById('enfant').value = data.config.enfant || 0;
                document.getElementById('report').value = data.config.report || 0;
                document.getElementById('cinquieme').value = data.config.cinquieme || 6;
                document.getElementById('weeklyRestDay').value = data.config.weeklyRestDay || 0;

                return true;
            } catch (e) {
                console.error('Erreur lors du chargement:', e);
                return false;
            }
        }

        // Sauvegarder automatiquement apr√®s chaque modification
        function autoSave() {
            const saved = saveToLocalStorage();
            if (saved) {
                // Afficher un indicateur discret de sauvegarde
                const indicator = document.getElementById('saveIndicator');
                if (indicator) {
                    indicator.style.display = 'inline';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                }
            }
        }

        // V√©rifier l'√©ch√©ance du 15 mai
        function checkMay15Deadline() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const may15 = new Date(currentYear, 4, 15); // 15 mai
            const daysUntilMay15 = Math.floor((may15 - today) / (1000 * 60 * 60 * 24));

            // Si on est avant le 15 mai et qu'il reste moins de 30 jours
            if (today < may15 && daysUntilMay15 <= 30 && daysUntilMay15 > 0) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'audit-alert warning';
                alertDiv.style.marginTop = '20px';
                alertDiv.innerHTML = `
                    <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                    <div>
                        <strong>Rappel important - √âch√©ance du 15 mai</strong><br>
                        Il reste <strong>${daysUntilMay15} jour(s)</strong> avant la date limite du 15 mai pour poser vos cong√©s selon les r√®gles CNETP.<br>
                        Assurez-vous d'avoir planifi√© toutes vos p√©riodes avant cette date.
                    </div>
                `;

                // Ajouter l'alerte apr√®s l'agent IA
                const aiAgent = document.querySelector('.ai-agent');
                if (aiAgent && !document.getElementById('may15Alert')) {
                    alertDiv.id = 'may15Alert';
                    aiAgent.insertAdjacentElement('afterend', alertDiv);
                }
            } else if (today >= may15) {
                // Si on est apr√®s le 15 mai, v√©rifier l'ann√©e suivante
                const nextMay15 = new Date(currentYear + 1, 4, 15);
                const daysUntilNextMay15 = Math.floor((nextMay15 - today) / (1000 * 60 * 60 * 24));

                if (daysUntilNextMay15 <= 30 && daysUntilNextMay15 > 0) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'audit-alert warning';
                    alertDiv.style.marginTop = '20px';
                    alertDiv.innerHTML = `
                        <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                        <div>
                            <strong>Rappel important - √âch√©ance du 15 mai ${currentYear + 1}</strong><br>
                            Il reste <strong>${daysUntilNextMay15} jour(s)</strong> avant la date limite du 15 mai ${currentYear + 1} pour poser vos cong√©s selon les r√®gles CNETP.
                        </div>
                    `;

                    const aiAgent = document.querySelector('.ai-agent');
                    if (aiAgent && !document.getElementById('may15Alert')) {
                        alertDiv.id = 'may15Alert';
                        aiAgent.insertAdjacentElement('afterend', alertDiv);
                    }
                }
            }
        }

        // ===== INITIALISATION =====
        document.addEventListener('DOMContentLoaded', function () {
            // Charger les donn√©es sauvegard√©es
            const loaded = loadFromLocalStorage();
            if (loaded) {
                updateAIMessage('‚úÖ Donn√©es charg√©es depuis la sauvegarde locale.', 'success');
            }

            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);

            document.getElementById('simStartDate').value = today.toISOString().split('T')[0];
            document.getElementById('simEndDate').value = nextWeek.toISOString().split('T')[0];

            calculateBalance();
            renderCalendar();
            renderHistoryTable();

            // V√©rifier l'√©ch√©ance du 15 mai
            checkMay15Deadline();

            // Suggestions initiales de l'IA
            setTimeout(() => {
                const totalDays = currentBalance.principal + currentBalance.cinquieme +
                    currentBalance.fractionnement + currentBalance.anciennete +
                    currentBalance.enfant + currentBalance.report;

                if (leaveHistory.length === 0) {
                    addAISuggestion(
                        'Commencer votre planification',
                        'Je peux vous aider √† planifier vos vacances sur toute l\'ann√©e. Cliquez sur "G√©n√©rer un plan" dans la section Planification Annuelle.',
                        () => generateYearlyPlan()
                    );
                } else {
                    addAISuggestion(
                        'Analyser votre historique',
                        'J\'ai d√©tect√© des p√©riodes enregistr√©es. Je peux analyser votre planification et vous donner des conseils d\'optimisation.',
                        () => analyzeHistory()
                    );
                }
            }, 1000);

            // Sauvegarder automatiquement toutes les 30 secondes
            setInterval(autoSave, 30000);
        });
    </script>
</body>

</html>