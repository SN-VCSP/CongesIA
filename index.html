<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONG√âS - Assistant IA pour vos Cong√©s</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Couleurs Vinci/Eurovia */
            --vinci-blue: #003366e3;
            --vinci-blue-dark: #001F3F;
            --vinci-blue-light: #004080;
            --vinci-red: #E30613;
            --vinci-red-dark: #C10510;
            --vinci-orange: #f7622c;
            --vinci-white: #FFFFFF;
            --vinci-gray: #F5F5F5;
            --vinci-gray-dark: #666666;
            --vinci-gray-light: #e0e0e0da;
            
            /* Application des couleurs */
            --primary: var(--vinci-blue);
            --primary-dark: var(--vinci-blue-dark);
            --secondary: var(--vinci-red);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: var(--vinci-red);
            --bg: var(--vinci-gray);
            --card: var(--vinci-white);
            --text: var(--vinci-blue-dark);
            --text-light: var(--vinci-gray-dark);
            --border: var(--vinci-gray-light);
            --gradient-1: linear-gradient(135deg, var(--vinci-blue) 0%, var(--vinci-blue-dark) 100%);
            --gradient-2: linear-gradient(135deg, var(--vinci-red) 0%, var(--vinci-red-dark) 100%);
            --gradient-3: linear-gradient(135deg, var(--vinci-blue-light) 0%, var(--vinci-blue) 100%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--gradient-1);
            color: white;
            padding: 30px 20px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 51, 102, 0.3);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: var(--vinci-red);
            border-radius: 50%;
            opacity: 0.1;
            transform: translate(30%, -30%);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 30px;
            position: relative;
            z-index: 1;
        }

        .logo-container {
            flex-shrink: 0;
        }

        .logo-eurovia {
            max-height: 80px;
            max-width: 200px;
            height: auto;
            width: auto;
            filter: brightness(0) invert(1);
        }

        .header-text {
            flex: 1;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            color: var(--vinci-white);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .ai-agent {
            background: var(--card);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid var(--vinci-blue);
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .ai-avatar {
            width: 60px;
            height: 60px;
            background: var(--gradient-2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 10px rgba(227, 6, 19, 0.3);
        }

        .ai-message {
            background: var(--bg);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid var(--vinci-blue);
            animation: slideIn 0.3s ease;
            line-height: 1.6;
        }

        .ai-suggestion {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid var(--vinci-blue);
            padding: 15px;
            border-radius: 8px;
            margin-top: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-suggestion:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 51, 102, 0.15);
        }

        .ai-suggestion-title {
            font-weight: bold;
            color: var(--vinci-blue);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-suggestion-desc {
            color: var(--text);
            font-size: 0.95rem;
        }

        .planning-helper {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .planning-helper h4 {
            color: var(--vinci-blue);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .planning-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .suggestion-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .suggestion-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: var(--vinci-blue);
        }

        .suggestion-card-title {
            font-weight: bold;
            color: var(--vinci-blue);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .suggestion-card-desc {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .suggestion-card-action {
            display: inline-block;
            padding: 6px 12px;
            background: var(--gradient-1);
            color: white;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .suggestion-card-action:hover {
            transform: scale(1.05);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: var(--vinci-blue);
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .balance-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .balance-item {
            background: var(--bg);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .balance-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--vinci-blue);
        }

        .balance-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--vinci-blue);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-1);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 51, 102, 0.3);
        }

        .btn-secondary {
            background: var(--gradient-3);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #b91c1c);
            color: white;
        }

        .simulation-result {
            background: var(--bg);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .gain-loss {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .gain, .loss {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .gain {
            background: linear-gradient(135deg, #d1fae515 0%, #6ee7b715 100%);
            border: 2px solid var(--success);
        }

        .loss {
            background: linear-gradient(135deg, #fee2e215 0%, #fecaca15 100%);
            border: 2px solid var(--danger);
        }

        .gain-label, .loss-label {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: var(--text-light);
        }

        .gain-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--success);
        }

        .loss-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--danger);
        }

        .history-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .history-table th {
            background: var(--bg);
            color: var(--vinci-blue);
            font-weight: 600;
        }

        .history-table tr:hover {
            background: var(--bg);
        }

        .history-table .btn {
            font-size: 0.85rem;
            padding: 6px 12px;
            white-space: nowrap;
        }

        .audit-alert {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .audit-alert.success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--success);
            color: #065f46;
        }

        .audit-alert.warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
            color: #92400e;
        }

        .audit-alert.error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--danger);
            color: #991b1b;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--vinci-blue);
            border-bottom-color: var(--vinci-blue);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* CALENDRIER INTERACTIF */
        .calendar-container {
            grid-column: 1 / -1;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: var(--gradient-1);
            border-radius: 12px;
            color: white;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 1rem;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .current-month {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .day-header {
            text-align: center;
            font-weight: bold;
            padding: 8px 4px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 8px;
            color: var(--vinci-blue);
            font-size: 0.75rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            min-height: 35px;
        }

        .calendar-day:hover {
            transform: scale(1.08);
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            border-color: var(--vinci-blue);
        }

        .calendar-day.other-month {
            opacity: 0.25;
        }

        .calendar-day.weekend {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        .calendar-day.holiday {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, var(--vinci-blue), var(--vinci-blue-light));
            color: white;
            border-color: var(--vinci-red);
            font-weight: bold;
        }

        .calendar-day.range-start,
        .calendar-day.range-end {
            background: linear-gradient(135deg, var(--vinci-red), var(--vinci-orange));
            color: white;
            font-weight: bold;
        }

        .calendar-day.in-range {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: var(--vinci-blue);
        }

        .day-number {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .day-indicator {
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--vinci-red);
        }

        .selection-info {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 2px solid var(--warning);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .selection-header {
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--vinci-blue);
        }

        .periods-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        .period-item {
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .period-item:hover {
            border-color: var(--vinci-blue);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .period-info {
            flex: 1;
        }

        .period-dates {
            font-size: 1rem;
            font-weight: bold;
            color: var(--vinci-blue);
            margin-bottom: 5px;
        }

        .period-days {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .period-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .selection-summary {
            background: var(--bg);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
        }

        .selection-total {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--vinci-red);
            margin-top: 8px;
        }

        /* Optimisations IA */
        .optimization-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid var(--success);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .optimization-card:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(16,185,129,0.3);
        }

        .optimization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .optimization-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--vinci-blue);
        }

        .optimization-badge {
            background: var(--success);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .optimization-details {
            color: var(--text);
            margin-bottom: 10px;
        }

        .optimization-gain {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-top: 15px;
        }

        .gain-item {
            flex: 1;
            text-align: center;
        }

        .tip-box {
            background: linear-gradient(135deg, #fef3c715 0%, #fde68a15 100%);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid var(--warning);
        }

        .tip-box strong {
            color: var(--warning);
        }

        .analysis-box {
            background: var(--bg);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid var(--vinci-blue);
        }

        .analysis-box h4 {
            color: var(--vinci-blue);
            margin-bottom: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 51, 102, 0.3);
            border-radius: 50%;
            border-top-color: var(--vinci-blue);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .logo-container {
                margin-bottom: 15px;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .balance-display {
                grid-template-columns: repeat(2, 1fr);
            }

            .gain-loss {
                grid-template-columns: 1fr;
            }

            .calendar-grid {
                gap: 5px;
            }

            .day-number {
                font-size: 0.8rem;
            }

            .calendar-day {
                min-height: 30px;
            }

            .planning-suggestions {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <img src="logo-eurovia.png" alt="Logo Eurovia" class="logo-eurovia" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display: none; color: white; font-weight: bold; font-size: 1.5rem;">EUROVIA</div>
                </div>
                <div class="header-text">
                    <h1>üéâ CONG√âS</h1>
                    <p>Votre assistant IA intelligent pour optimiser vos cong√©s CNETP</p>
                </div>
            </div>
        </header>

        <div class="ai-agent">
            <div class="ai-header">
                <div class="ai-avatar">ü§ñ</div>
                <div>
                    <h3>Assistant IA</h3>
                    <p style="color: var(--text-light); font-size: 0.9rem;">Pr√™t √† vous aider √† optimiser vos cong√©s</p>
                </div>
            </div>
            <div id="aiMessage" class="ai-message">
                <strong>üëã Bonjour !</strong> Je suis votre assistant IA pour optimiser vos cong√©s CNETP sur toute l'ann√©e.<br><br>
                <strong>üí° Comment je peux vous aider :</strong>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li><strong>Planification annuelle</strong> : Je vous sugg√®re les meilleures p√©riodes pour vos vacances</li>
                    <li><strong>Optimisation intelligente</strong> : Je trouve les ponts et optimise vos dates pour maximiser vos jours de repos</li>
                    <li><strong>Conseils personnalis√©s</strong> : Je vous guide pour obtenir le fractionnement et optimiser votre solde</li>
                    <li><strong>Vue d'ensemble</strong> : Je vous aide √† visualiser et planifier toute votre ann√©e</li>
                </ul>
                <div id="aiSuggestions"></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('calendar')">üìÖ Calendrier</button>
            <button class="tab" onclick="switchTab('balance')">üìä Mon Solde</button>
            <button class="tab" onclick="switchTab('simulate')">üéØ Simulation</button>
            <button class="tab" onclick="switchTab('history')">üìã Historique</button>
            <button class="tab" onclick="switchTab('audit')">üîç Audit</button>
        </div>

        <!-- Tab: Calendrier Interactif -->
        <div id="calendarTab" class="tab-content active">
            <div class="grid">
                <div class="card calendar-container">
                    <h3><span class="card-icon">üìÖ</span> Calendrier Interactif</h3>
                    
                    <div class="calendar-header">
                        <button class="nav-btn" onclick="previousMonth()">‚óÄ</button>
                        <div class="current-month" id="currentMonth">Janvier 2025</div>
                        <button class="nav-btn" onclick="nextMonth()">‚ñ∂</button>
                    </div>

                    <div id="selectionInfo" class="selection-info" style="display: none;">
                        <div class="selection-header">üìç P√©riodes s√©lectionn√©es</div>
                        <div id="periodsList" class="periods-list"></div>
                        <div class="selection-summary">
                            <div style="font-size: 0.9rem; color: var(--text-light);">Total de jours ouvrables</div>
                            <div class="selection-total" id="selectionTotal">0 jours</div>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="confirmAllSelections()">‚úì Valider toutes les p√©riodes</button>
                            <button class="btn btn-warning" onclick="clearAllSelections()">üóëÔ∏è Effacer toutes les s√©lections</button>
                        </div>
                    </div>

                    <div class="calendar-grid" id="calendarGrid"></div>

                    <div style="margin-top: 20px; padding: 15px; background: var(--bg); border-radius: 10px; border-left: 4px solid var(--vinci-blue);">
                        <div style="font-weight: bold; color: var(--vinci-blue); margin-bottom: 8px;">üí° Comment planifier plusieurs p√©riodes :</div>
                        <div style="font-size: 0.9rem; color: var(--text-light); line-height: 1.6;">
                            1. Cliquez sur une date de d√©but<br>
                            2. Cliquez sur une date de fin pour cr√©er une p√©riode<br>
                            3. R√©p√©tez pour ajouter d'autres p√©riodes<br>
                            4. Validez toutes les p√©riodes en une fois ou individuellement
                        </div>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="optimizeSelection()">üéØ Optimiser la p√©riode</button>
                        <button class="btn btn-warning" onclick="clearSelection()">üóëÔ∏è Effacer s√©lection en cours</button>
                    </div>
                </div>

                <div class="card">
                    <h3><span class="card-icon">üéÅ</span> Optimisations IA</h3>
                    <div id="optimizations">
                        <p style="color: var(--text-light); text-align: center; padding: 40px;">
                            S√©lectionnez une p√©riode sur le calendrier pour voir les optimisations possibles
                        </p>
                    </div>
                </div>

                <div class="card planning-helper">
                    <h4><span class="card-icon">üìÖ</span> Planification Annuelle - Conseils IA</h4>
                    <p style="color: var(--text-light); margin-bottom: 15px; font-size: 0.95rem;">
                        Laissez-moi vous aider √† planifier vos vacances sur toute l'ann√©e pour optimiser votre solde et profiter au maximum.
                    </p>
                    <div id="planningSuggestions" class="planning-suggestions">
                        <div class="suggestion-card">
                            <div class="suggestion-card-title">üåâ Optimiser les ponts</div>
                            <div class="suggestion-card-desc">Je peux identifier les meilleurs ponts de l'ann√©e pour maximiser vos jours de repos</div>
                            <button class="suggestion-card-action" onclick="suggestBridges()">Voir les ponts</button>
                        </div>
                        <div class="suggestion-card">
                            <div class="suggestion-card-title">‚òÄÔ∏è P√©riode estivale</div>
                            <div class="suggestion-card-desc">Planifiez 12 jours continus en √©t√© pour obtenir le fractionnement</div>
                            <button class="suggestion-card-action" onclick="suggestSummerPeriod()">Sugg√©rer une p√©riode</button>
                        </div>
                        <div class="suggestion-card">
                            <div class="suggestion-card-title">‚ùÑÔ∏è P√©riode hivernale</div>
                            <div class="suggestion-card-desc">R√©servez 3-6 jours du principal en hiver pour maximiser le fractionnement</div>
                            <button class="suggestion-card-action" onclick="suggestWinterPeriod()">Sugg√©rer une p√©riode</button>
                        </div>
                        <div class="suggestion-card">
                            <div class="suggestion-card-title">üìä Analyse compl√®te</div>
                            <div class="suggestion-card-desc">J'analyse votre situation et vous propose un plan d'optimisation personnalis√©</div>
                            <button class="suggestion-card-action" onclick="generateYearlyPlan()">G√©n√©rer un plan</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Balance -->
        <div id="balanceTab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3><span class="card-icon">‚öôÔ∏è</span> Configuration</h3>
                    <div class="form-group">
                        <label>Droits annuels acquis (jours ouvrables)</label>
                        <input type="number" id="annualRights" value="30" min="0" onchange="calculateBalance()">
                    </div>
                    <div class="form-group">
                        <label>CP Anciennet√©</label>
                        <input type="number" id="anciennete" value="0" min="0" onchange="calculateBalance()">
                    </div>
                    <div class="form-group">
                        <label>CP Enfant √† charge</label>
                        <input type="number" id="enfant" value="0" min="0" onchange="calculateBalance()">
                    </div>
                    <div class="form-group">
                        <label>Report (N-1)</label>
                        <input type="number" id="report" value="0" min="0" onchange="calculateBalance()">
                    </div>
                    <div class="form-group">
                        <label>5√®me Semaine</label>
                        <input type="number" id="cinquieme" value="6" min="0" onchange="calculateBalance()">
                    </div>
                    <div class="form-group">
                        <label>Fractionnement (estim√© automatiquement)</label>
                        <input type="number" id="fractionnement" value="0" min="0" readonly style="background: var(--bg);">
                    </div>
                    <div class="form-group">
                        <label>Jour de repos hebdomadaire</label>
                        <select id="weeklyRestDay" onchange="calculateBalance()">
                            <option value="0">Dimanche</option>
                            <option value="1">Lundi</option>
                            <option value="2">Mardi</option>
                            <option value="3">Mercredi</option>
                            <option value="4">Jeudi</option>
                            <option value="5">Vendredi</option>
                            <option value="6">Samedi</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="calculateBalance()">
                        üîÑ Recalculer le solde
                    </button>
                </div>

                <div class="card">
                    <h3><span class="card-icon">üíº</span> Votre Solde Actuel</h3>
                    <div class="balance-display">
                        <div class="balance-item">
                            <div class="balance-value" id="balancePrincipal">24</div>
                            <div class="balance-label">Principal</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-value" id="balanceCinquieme">6</div>
                            <div class="balance-label">5√®me Semaine</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-value" id="balanceFractionnement">0</div>
                            <div class="balance-label">Fractionnement</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-value" id="balanceAnciennete">0</div>
                            <div class="balance-label">Anciennet√©</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-value" id="balanceEnfant">0</div>
                            <div class="balance-label">Enfant</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-value" id="balanceReport">0</div>
                            <div class="balance-label">Report N-1</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Simulate -->
        <div id="simulateTab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3><span class="card-icon">üéØ</span> Simulation de Cong√©s</h3>
                    <div class="form-group">
                        <label>Date de d√©but</label>
                        <input type="date" id="simStartDate">
                    </div>
                    <div class="form-group">
                        <label>Date de fin</label>
                        <input type="date" id="simEndDate">
                    </div>
                    <button class="btn btn-primary" onclick="runSimulation()">
                        ‚ñ∂Ô∏è Lancer la simulation
                    </button>
                </div>

                <div class="card">
                    <h3><span class="card-icon">üìà</span> R√©sultat de la Simulation</h3>
                    <div id="simulationResult">
                        <p style="color: var(--text-light); text-align: center; padding: 40px;">
                            Configurez et lancez une simulation pour voir les r√©sultats
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: History -->
        <div id="historyTab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3><span class="card-icon">‚ûï</span> Ajouter une P√©riode</h3>
                    <div class="form-group">
                        <label>Date de d√©but</label>
                        <input type="date" id="newLeaveStart">
                    </div>
                    <div class="form-group">
                        <label>Date de fin</label>
                        <input type="date" id="newLeaveEnd">
                    </div>
                    <div class="form-group">
                        <label>Nombre de jours (optionnel - sera calcul√© automatiquement)</label>
                        <input type="number" id="newLeaveDays" min="0" placeholder="Laisser vide pour calcul automatique">
                    </div>
                    <button class="btn btn-primary" onclick="addLeavePeriod()">
                        ‚ûï Ajouter cette p√©riode
                    </button>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
                        <h4 style="color: var(--vinci-blue); margin-bottom: 15px;">üì• Import JSON (optionnel)</h4>
                        <div class="form-group">
                            <label>Importer un historique en JSON</label>
                            <textarea id="historyInput" rows="3" placeholder='[{"debut": "2024-05-15", "fin": "2024-05-20", "jours": 5}]'></textarea>
                        </div>
                        <button class="btn btn-secondary" onclick="importHistory()">
                            üì• Importer depuis JSON
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3><span class="card-icon">üìã</span> Historique enregistr√©</h3>
                    <div id="historyTableContainer" style="margin-top: 20px;">
                        <p style="color: var(--text-light); text-align: center; padding: 20px;">
                            Aucune p√©riode de cong√© enregistr√©e. Ajoutez votre premi√®re p√©riode ci-contre ou utilisez le calendrier.
                        </p>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="analyzeHistory()" id="analyzeBtn" style="display: none;">
                            üß† Analyser avec l'IA
                        </button>
                        <button class="btn btn-secondary" onclick="clearHistory()" id="clearBtn" style="display: none;">
                            üóëÔ∏è Effacer tout l'historique
                        </button>
                        <button class="btn btn-secondary" onclick="exportHistory()" id="exportBtn" style="display: none;">
                            üíæ Exporter en JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Audit -->
        <div id="auditTab" class="tab-content">
            <div class="card">
                <h3><span class="card-icon">üîç</span> Audit Annuel</h3>
                <p style="margin-bottom: 20px; color: var(--text-light);">
                    V√©rifiez que votre d√©compte de jours sur l'ann√©e est correct.
                </p>
                <button class="btn btn-primary" onclick="runAudit()">
                    üîç Lancer l'audit
                </button>
                <div id="auditResults" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const JOURS_FERIES_2025 = [
            { date: '2025-01-01', nom: 'Jour de l\'an' },
            { date: '2025-04-21', nom: 'Lundi de P√¢ques' },
            { date: '2025-05-01', nom: 'F√™te du Travail' },
            { date: '2025-05-08', nom: 'Victoire 1945' },
            { date: '2025-05-29', nom: 'Ascension' },
            { date: '2025-06-09', nom: 'Lundi de Pentec√¥te' },
            { date: '2025-07-14', nom: 'F√™te Nationale' },
            { date: '2025-08-15', nom: 'Assomption' },
            { date: '2025-11-01', nom: 'Toussaint' },
            { date: '2025-11-11', nom: 'Armistice 1918' },
            { date: '2025-12-25', nom: 'No√´l' }
        ];

        const publicHolidays = [
            '2024-01-01', '2024-04-01', '2024-05-01', '2024-05-08', '2024-05-09',
            '2024-05-20', '2024-07-14', '2024-08-15', '2024-11-01', '2024-11-11',
            '2024-12-25', '2025-01-01', '2025-04-21', '2025-05-01', '2025-05-08',
            '2025-05-29', '2025-06-09', '2025-07-14', '2025-08-15', '2025-11-01',
            '2025-11-11', '2025-12-25'
        ];

        // ===== √âTAT GLOBAL =====
        let currentBalance = {
            anciennete: 0,
            enfant: 0,
            report: 0,
            cinquieme: 6,
            fractionnement: 0,
            principal: 24
        };

        let leaveHistory = [];
        
        // √âtat du calendrier
        let currentDate = new Date();
        let selectedDates = []; // Dates de la p√©riode en cours de s√©lection
        let selectionMode = false;
        let rangeStart = null;
        let pendingPeriods = []; // Toutes les p√©riodes en attente de validation

        // ===== FONCTIONS UTILITAIRES CNETP =====
        function isOuvrable(date, weeklyRestDay = 0) {
            const day = date.getDay();
            if (day === weeklyRestDay) return false;
            
            const dateStr = date.toISOString().split('T')[0];
            if (publicHolidays.includes(dateStr)) return false;
            
            return true;
        }

        function countOuvrables(start, end, weeklyRestDay = 0) {
            let count = 0;
            const current = new Date(start);
            const endDate = new Date(end);
            
            while (current <= endDate) {
                if (isOuvrable(current, weeklyRestDay)) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            return count;
        }

        function getLastOuvrableBefore(reprise, weeklyRestDay = 0) {
            let d = new Date(reprise);
            d.setDate(d.getDate() - 1);
            while (!isOuvrable(d, weeklyRestDay)) {
                d.setDate(d.getDate() - 1);
            }
            return d;
        }

        function imputeDays(rights, daysNeeded) {
            const remaining = {...rights};
            const consumed = {
                ANCIENNETE: 0,
                ENFANT: 0,
                REPORT: 0,
                CINQUIEME: 0,
                FRACTIONNEMENT: 0,
                PRINCIPAL: 0
            };

            let leftToConsume = daysNeeded;
            const order = ['anciennete', 'enfant', 'report', 'cinquieme', 'fractionnement', 'principal'];
            const orderMap = {
                'anciennete': 'ANCIENNETE',
                'enfant': 'ENFANT',
                'report': 'REPORT',
                'cinquieme': 'CINQUIEME',
                'fractionnement': 'FRACTIONNEMENT',
                'principal': 'PRINCIPAL'
            };

            for (const type of order) {
                if (leftToConsume <= 0) break;
                const available = remaining[type];
                const toConsume = Math.min(available, leftToConsume);
                remaining[type] -= toConsume;
                consumed[orderMap[type]] = toConsume;
                leftToConsume -= toConsume;
            }

            return { remaining, consumed, totalConsumed: daysNeeded - leftToConsume };
        }

        function calculateFractionnement(params) {
            if (params.annualRightsAcquired < 15) return 0;
            
            if (!params.isContinuous12Summer && !params.allLeavesInWinter) {
                return 0;
            }

            const daysSubjectToBonus = params.principalDaysTakenWinter;
            if (daysSubjectToBonus >= 6) return 2;
            if (daysSubjectToBonus >= 3) return 1;
            return 0;
        }

        // ===== INTERFACE =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Rafra√Æchir le calendrier si on bascule dessus
            if (tabName === 'calendar') {
                renderCalendar();
            }
        }

        function updateAIMessage(message, type = 'info') {
            const aiMessage = document.getElementById('aiMessage');
            const suggestionsDiv = document.getElementById('aiSuggestions');
            
            // Garder le message principal et ajouter les suggestions
            const baseMessage = message.includes('<strong>üëã') ? message : 
                `<strong>üí¨ Assistant IA :</strong><br>${message}`;
            
            aiMessage.innerHTML = baseMessage;
            if (suggestionsDiv) {
                suggestionsDiv.innerHTML = '';
            }
            
            aiMessage.style.borderLeftColor = type === 'success' ? 'var(--success)' : 
                                             type === 'warning' ? 'var(--warning)' : 
                                             type === 'error' ? 'var(--danger)' : 'var(--vinci-blue)';
        }

        function addAISuggestion(title, description, action) {
            const suggestionsDiv = document.getElementById('aiSuggestions');
            if (!suggestionsDiv) return;
            
            const suggestion = document.createElement('div');
            suggestion.className = 'ai-suggestion';
            suggestion.innerHTML = `
                <div class="ai-suggestion-title">üí° ${title}</div>
                <div class="ai-suggestion-desc">${description}</div>
            `;
            if (action) {
                suggestion.onclick = action;
            }
            suggestionsDiv.appendChild(suggestion);
        }

        // ===== CALENDRIER =====
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Mise √† jour du titre
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                              'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

            // Cr√©ation de la grille
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // En-t√™tes des jours
            const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Premier jour du mois
            const firstDay = new Date(year, month, 1);
            let dayOfWeek = firstDay.getDay();
            dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            // Derniers jours du mois pr√©c√©dent
            const prevMonthDays = new Date(year, month, 0).getDate();
            for (let i = dayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                const cell = createDayCell(year, month - 1, day, true);
                grid.appendChild(cell);
            }

            // Jours du mois actuel
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = createDayCell(year, month, day, false);
                grid.appendChild(cell);
            }

            // Premiers jours du mois suivant
            const remainingCells = 42 - grid.children.length + 7;
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createDayCell(year, month + 1, day, true);
                grid.appendChild(cell);
            }
        }

        function createDayCell(year, month, day, otherMonth) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            
            const date = new Date(year, month, day);
            const dateStr = formatDate(date);
            
            if (otherMonth) {
                cell.classList.add('other-month');
            }

            // Weekend
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                cell.classList.add('weekend');
            }

            // Jour f√©ri√©
            if (isHoliday(dateStr)) {
                cell.classList.add('holiday');
            }

            // S√©lectionn√© (p√©riode en cours)
            if (selectedDates.includes(dateStr)) {
                cell.classList.add('selected');
            }

            // P√©riodes en attente
            pendingPeriods.forEach(period => {
                if (period.dates && period.dates.includes(dateStr)) {
                    cell.classList.add('selected');
                }
            });

            // Range selection (p√©riode en cours de s√©lection)
            if (rangeStart && selectionMode) {
                const start = new Date(rangeStart);
                if (date >= start) {
                    if (dateStr === rangeStart) {
                        cell.classList.add('range-start');
                    } else {
                        cell.classList.add('in-range');
                    }
                }
            }

            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            cell.appendChild(dayNumber);

            // Indicateur si p√©riode enregistr√©e
            if (hasLeaveOnDate(dateStr)) {
                const indicator = document.createElement('div');
                indicator.className = 'day-indicator';
                cell.appendChild(indicator);
            }

            cell.onclick = () => selectDate(dateStr, date);

            return cell;
        }

        function selectDate(dateStr, date) {
            if (!selectionMode) {
                // Premier clic - d√©but d'une nouvelle p√©riode
                rangeStart = dateStr;
                selectionMode = true;
                selectedDates = [dateStr];
                updateSelectionInfo();
            } else {
                // Deuxi√®me clic - fin de la p√©riode
                const start = new Date(rangeStart);
                const end = date;
                
                // V√©rifier que la fin est apr√®s le d√©but
                if (end < start) {
                    updateAIMessage('‚ö†Ô∏è La date de fin doit √™tre apr√®s la date de d√©but', 'warning');
                    return;
                }
                
                selectedDates = [];
                let current = new Date(start);
                
                while (current <= end) {
                    selectedDates.push(formatDate(current));
                    current.setDate(current.getDate() + 1);
                }
                
                // Ajouter cette p√©riode √† la liste des p√©riodes en attente
                const workDays = countWorkDaysFromDates(selectedDates);
                pendingPeriods.push({
                    start: formatDate(new Date(start)),
                    end: formatDate(end),
                    dates: [...selectedDates],
                    jours: workDays
                });
                
                // R√©initialiser pour la prochaine s√©lection
                selectedDates = [];
                rangeStart = null;
                selectionMode = false;
                
                updateSelectionInfo();
            }
            
            renderCalendar();
        }

        function updateSelectionInfo() {
            const info = document.getElementById('selectionInfo');
            const periodsList = document.getElementById('periodsList');
            const selectionTotal = document.getElementById('selectionTotal');
            
            // Afficher si on a des p√©riodes en attente ou une s√©lection en cours
            if (pendingPeriods.length > 0 || (selectedDates.length > 0 && selectionMode)) {
                info.style.display = 'block';
                
                // Afficher la p√©riode en cours de s√©lection si elle existe
                let html = '';
                
                // P√©riode en cours de s√©lection (si pas encore compl√©t√©e)
                if (selectedDates.length > 0 && selectionMode && rangeStart) {
                    const start = selectedDates[0];
                    const end = selectedDates.length > 1 ? selectedDates[selectedDates.length - 1] : start;
                    const workDays = countWorkDaysFromDates(selectedDates);
                    
                    html += `
                        <div class="period-item" style="border-color: var(--warning);">
                            <div class="period-info">
                                <div class="period-dates">‚è≥ En cours : Du ${formatDisplayDate(start)} au ${formatDisplayDate(end)}</div>
                                <div class="period-days">${workDays} jours ouvrables - Cliquez sur une date de fin pour finaliser</div>
                            </div>
                        </div>
                    `;
                }
                
                // P√©riodes en attente de validation
                pendingPeriods.forEach((period, index) => {
                    html += `
                        <div class="period-item">
                            <div class="period-info">
                                <div class="period-dates">üìÖ Du ${formatDisplayDate(period.start)} au ${formatDisplayDate(period.end)}</div>
                                <div class="period-days">${period.jours} jours ouvrables</div>
                            </div>
                            <div class="period-actions">
                                <button class="btn btn-success btn-small" onclick="confirmSinglePeriod(${index})">‚úì Valider</button>
                                <button class="btn btn-danger btn-small" onclick="removePendingPeriod(${index})">‚úó Supprimer</button>
                            </div>
                        </div>
                    `;
                });
                
                periodsList.innerHTML = html;
                
                // Calculer le total
                const totalDays = pendingPeriods.reduce((sum, p) => sum + p.jours, 0);
                selectionTotal.textContent = `${totalDays} jours ouvrables`;
            } else {
                info.style.display = 'none';
            }
        }

        function confirmAllSelections() {
            if (pendingPeriods.length === 0) {
                updateAIMessage('‚ö†Ô∏è Aucune p√©riode √† valider. S√©lectionnez d\'abord des p√©riodes sur le calendrier.', 'warning');
                return;
            }
            
            let totalDays = 0;
            let addedCount = 0;
            
            pendingPeriods.forEach(period => {
                leaveHistory.push({
                    debut: period.start,
                    fin: period.end,
                    jours: period.jours,
                    dates: [...period.dates]
                });
                totalDays += period.jours;
                addedCount++;
            });
            
            // R√©initialiser
            pendingPeriods = [];
            selectedDates = [];
            rangeStart = null;
            selectionMode = false;
            
            renderCalendar();
            renderHistoryTable();
            updateStats();
            
            // Message intelligent
            let message = `‚úÖ <strong>${addedCount} p√©riode(s) ajout√©e(s) avec succ√®s !</strong><br><br>`;
            message += `üìä Total : ${totalDays} jours ouvrables consomm√©s<br><br>`;
            
            // Calculer le solde restant
            const totalTaken = leaveHistory.reduce((sum, l) => sum + l.jours, 0);
            const totalAvailable = currentBalance.principal + currentBalance.cinquieme + 
                                 currentBalance.fractionnement + currentBalance.anciennete + 
                                 currentBalance.enfant + currentBalance.report;
            const remaining = totalAvailable - totalTaken;
            
            message += `üí∞ <strong>Solde restant estim√© :</strong> ${remaining} jours`;
            
            if (remaining < 5) {
                message += `<br>‚ö†Ô∏è Attention, votre solde est faible. Planifiez bien vos prochaines p√©riodes.`;
            }
            
            updateAIMessage(message, 'success');
            updateSelectionInfo();
        }

        function confirmSinglePeriod(index) {
            if (index < 0 || index >= pendingPeriods.length) return;
            
            const period = pendingPeriods[index];
            const startDate = new Date(period.start);
            const month = startDate.getMonth();
            
            leaveHistory.push({
                debut: period.start,
                fin: period.end,
                jours: period.jours,
                dates: [...period.dates]
            });
            
            // Retirer de la liste des p√©riodes en attente
            pendingPeriods.splice(index, 1);
            
            renderCalendar();
            renderHistoryTable();
            updateStats();
            updateSelectionInfo();
            
            // Message intelligent avec conseils
            let message = `‚úÖ <strong>P√©riode ajout√©e avec succ√®s !</strong><br><br>`;
            message += `üìÖ Du ${formatDisplayDate(period.start)} au ${formatDisplayDate(period.end)}<br>`;
            message += `üìä ${period.jours} jours ouvrables consomm√©s<br><br>`;
            
            // Conseils selon la p√©riode
            if (month >= 4 && month <= 9) {
                message += `‚òÄÔ∏è <strong>P√©riode estivale</strong> : `;
                if (period.jours >= 12) {
                    message += `Excellent ! Vous respectez la condition des 12 jours continus pour le fractionnement.`;
                } else {
                    message += `Pensez √† prendre au moins 12 jours continus en √©t√© pour √™tre √©ligible au fractionnement.`;
                }
            } else {
                message += `‚ùÑÔ∏è <strong>P√©riode hivernale</strong> : `;
                const totalTaken = leaveHistory.reduce((sum, l) => {
                    const lMonth = new Date(l.debut).getMonth();
                    return (lMonth < 4 || lMonth > 9) ? sum + l.jours : sum;
                }, 0);
                if (totalTaken >= 6) {
                    message += `Parfait ! Vous avez ${totalTaken} jours en hiver, ce qui vous donne droit au fractionnement maximum (+2 jours).`;
                } else if (totalTaken >= 3) {
                    message += `Bien ! Vous avez ${totalTaken} jours en hiver, ce qui vous donne droit √† +1 jour de fractionnement.`;
                } else {
                    message += `Pour optimiser, essayez de prendre 3-6 jours du principal en hiver pour obtenir le fractionnement.`;
                }
            }
            
            // Calculer le solde restant
            const totalTaken = leaveHistory.reduce((sum, l) => sum + l.jours, 0);
            const totalAvailable = currentBalance.principal + currentBalance.cinquieme + 
                                 currentBalance.fractionnement + currentBalance.anciennete + 
                                 currentBalance.enfant + currentBalance.report;
            const remaining = totalAvailable - totalTaken;
            
            message += `<br><br>üí∞ <strong>Solde restant estim√© :</strong> ${remaining} jours`;
            
            if (remaining < 5) {
                message += `<br>‚ö†Ô∏è Attention, votre solde est faible. Planifiez bien vos prochaines p√©riodes.`;
            }
            
            updateAIMessage(message, 'success');
        }

        function removePendingPeriod(index) {
            if (index < 0 || index >= pendingPeriods.length) return;
            
            pendingPeriods.splice(index, 1);
            renderCalendar();
            updateSelectionInfo();
            
            if (pendingPeriods.length === 0 && !selectionMode) {
                updateAIMessage('‚ÑπÔ∏è P√©riode supprim√©e. Vous pouvez continuer √† s√©lectionner d\'autres p√©riodes.', 'info');
            }
        }

        function cancelSelection() {
            selectedDates = [];
            rangeStart = null;
            selectionMode = false;
            renderCalendar();
            updateSelectionInfo();
        }

        function clearSelection() {
            selectedDates = [];
            rangeStart = null;
            selectionMode = false;
            renderCalendar();
            updateSelectionInfo();
        }

        function clearAllSelections() {
            if (pendingPeriods.length === 0 && !selectionMode) {
                updateAIMessage('‚ÑπÔ∏è Aucune s√©lection en cours.', 'info');
                return;
            }
            
            if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les p√©riodes s√©lectionn√©es ?')) {
                pendingPeriods = [];
                selectedDates = [];
                rangeStart = null;
                selectionMode = false;
                renderCalendar();
                updateSelectionInfo();
                updateAIMessage('‚úÖ Toutes les s√©lections ont √©t√© effac√©es.', 'success');
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        // ===== OPTIMISATIONS IA =====
        function optimizeSelection() {
            // Utiliser la p√©riode en cours de s√©lection ou la derni√®re p√©riode en attente
            let periodToOptimize = null;
            
            if (selectedDates.length > 0 && selectionMode) {
                // P√©riode en cours de s√©lection
                periodToOptimize = {
                    start: selectedDates[0],
                    end: selectedDates[selectedDates.length - 1],
                    dates: selectedDates,
                    jours: countWorkDaysFromDates(selectedDates)
                };
            } else if (pendingPeriods.length > 0) {
                // Utiliser la derni√®re p√©riode en attente
                periodToOptimize = pendingPeriods[pendingPeriods.length - 1];
            } else {
                updateAIMessage('‚ö†Ô∏è Veuillez d\'abord s√©lectionner une p√©riode sur le calendrier', 'warning');
                return;
            }

            const start = new Date(periodToOptimize.start);
            const end = new Date(periodToOptimize.end);
            const workDays = periodToOptimize.jours;
            
            const optimizations = generateOptimizations(start, end, workDays);
            renderOptimizations(optimizations);
            
            let message = `üéØ J'ai analys√© votre p√©riode et trouv√© ${optimizations.length} optimisation(s) possible(s) !`;
            
            // Conseils personnalis√©s selon la p√©riode
            const month = start.getMonth();
            if (month >= 4 && month <= 9) {
                message += '<br><br>‚òÄÔ∏è <strong>P√©riode estivale d√©tect√©e</strong> : Parfait pour votre p√©riode principale. ';
                if (workDays >= 12) {
                    message += 'Vous respectez la condition des 12 jours continus pour le fractionnement !';
                } else {
                    message += `Pensez √† prendre au moins 12 jours continus en √©t√© pour √™tre √©ligible au fractionnement.`;
                }
            } else {
                message += '<br><br>‚ùÑÔ∏è <strong>P√©riode hivernale</strong> : Excellente strat√©gie pour optimiser le fractionnement !';
            }
            
            if (pendingPeriods.length > 1) {
                message += `<br><br>üí° Vous avez ${pendingPeriods.length} p√©riodes en attente. Vous pouvez optimiser chaque p√©riode individuellement.`;
            }
            
            updateAIMessage(message, 'success');
            
            // Suggestions suppl√©mentaires
            if (optimizations.length > 0) {
                optimizations.forEach(opt => {
                    if (opt.gain > 0) {
                        addAISuggestion(
                            opt.title,
                            opt.description,
                            () => applyOptimization(optimizations.indexOf(opt))
                        );
                    }
                });
            }
        }

        function generateOptimizations(start, end, currentDays) {
            const optimizations = [];
            
            // Optimisation 1 : Ponts
            const bridges = findBridges(start, end);
            if (bridges.length > 0) {
                bridges.forEach(bridge => {
                    optimizations.push({
                        title: `üåâ Faire le pont de ${bridge.holiday}`,
                        description: `En posant ${bridge.extraDays} jour(s) suppl√©mentaire(s), vous obtenez ${bridge.totalDays} jours de repos cons√©cutifs`,
                        newStart: bridge.newStart,
                        newEnd: bridge.newEnd,
                        extraDays: bridge.extraDays,
                        totalDays: bridge.totalDays,
                        gain: bridge.totalDays - currentDays,
                        efficiency: (bridge.totalDays / (currentDays + bridge.extraDays) * 100).toFixed(0)
                    });
                });
            }
            
            // Optimisation 2 : Fractionnement
            const fractOptim = optimizeFractionnement(start, end, currentDays);
            if (fractOptim) {
                optimizations.push(fractOptim);
            }
            
            // Optimisation 3 : Weekends
            const weekendOptim = optimizeWeekends(start, end, currentDays);
            if (weekendOptim) {
                optimizations.push(weekendOptim);
            }
            
            // Optimisation 4 : P√©riode estivale
            const summerOptim = optimizeSummerPeriod(start, end, currentDays);
            if (summerOptim) {
                optimizations.push(summerOptim);
            }
            
            return optimizations;
        }

        function findBridges(start, end) {
            const bridges = [];
            const nearby = JOURS_FERIES_2025.filter(h => {
                const holidayDate = new Date(h.date);
                const diffDays = Math.abs((holidayDate - start) / (1000 * 60 * 60 * 24));
                return diffDays <= 5;
            });
            
            nearby.forEach(holiday => {
                const holidayDate = new Date(holiday.date);
                const dayOfWeek = holidayDate.getDay();
                
                if (dayOfWeek === 4) {
                    bridges.push({
                        holiday: holiday.nom,
                        extraDays: 1,
                        totalDays: 4,
                        newStart: formatDate(holidayDate),
                        newEnd: formatDate(new Date(holidayDate.getFullYear(), holidayDate.getMonth(), holidayDate.getDate() + 3))
                    });
                }
                
                if (dayOfWeek === 2) {
                    bridges.push({
                        holiday: holiday.nom,
                        extraDays: 1,
                        totalDays: 4,
                        newStart: formatDate(new Date(holidayDate.getFullYear(), holidayDate.getMonth(), holidayDate.getDate() - 3)),
                        newEnd: formatDate(holidayDate)
                    });
                }
            });
            
            return bridges;
        }

        function optimizeFractionnement(start, end, currentDays) {
            const month = start.getMonth();
            
            if (month >= 4 && month <= 9) {
                if (currentDays >= 12) {
                    const winterDaysNeeded = 6;
                    return {
                        title: `üéÅ Maximiser le fractionnement`,
                        description: `Gardez ${winterDaysNeeded} jours pour l'hiver (Nov-Avr) pour obtenir +2 jours de fractionnement`,
                        extraDays: 0,
                        totalDays: currentDays,
                        gain: 2,
                        efficiency: 100,
                        tip: `En prenant vos cong√©s principaux en √©t√© et en gardant quelques jours pour l'hiver, vous gagnez des jours bonus !`
                    };
                }
            }
            
            return null;
        }

        function optimizeWeekends(start, end, currentDays) {
            const startDay = start.getDay();
            
            if (startDay !== 1 && startDay !== 0) {
                const daysToMonday = startDay === 0 ? 1 : (8 - startDay);
                return {
                    title: `üìÖ Optimiser les weekends`,
                    description: `Commencez votre cong√© un lundi pour maximiser les weekends inclus`,
                    extraDays: 0,
                    gain: daysToMonday > 3 ? 0 : 2,
                    tip: `En calant vos cong√©s du lundi au vendredi, vous profitez des weekends sans les consommer`
                };
            }
            
            return null;
        }

        function optimizeSummerPeriod(start, end, currentDays) {
            const month = start.getMonth();
            
            if (month >= 4 && month <= 9 && currentDays >= 12) {
                return {
                    title: `‚òÄÔ∏è P√©riode estivale optimale`,
                    description: `Votre p√©riode respecte les conditions pour le fractionnement (12 jours continus en √©t√©)`,
                    extraDays: 0,
                    totalDays: currentDays,
                    gain: 0,
                    efficiency: 100,
                    tip: `Parfait pour obtenir vos jours de fractionnement !`
                };
            }
            
            return null;
        }

        function renderOptimizations(optimizations) {
            const container = document.getElementById('optimizations');
            
            if (optimizations.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--text-light); text-align: center; padding: 40px;">
                        Aucune optimisation trouv√©e pour cette p√©riode
                    </p>
                `;
                return;
            }
            
            container.innerHTML = optimizations.map((opt, index) => `
                <div class="optimization-card" onclick="applyOptimization(${index})">
                    <div class="optimization-header">
                        <div class="optimization-title">${opt.title}</div>
                        <div class="optimization-badge">+${opt.gain} jour${opt.gain > 1 ? 's' : ''}</div>
                    </div>
                    <div class="optimization-details">${opt.description}</div>
                    ${opt.tip ? `<div style="font-size: 0.9rem; color: var(--text-light); margin-top: 10px;">üí° ${opt.tip}</div>` : ''}
                    <div class="optimization-gain">
                        <div class="gain-item">
                            <div class="gain-label">Jours √† poser</div>
                            <div class="gain-value">${opt.totalDays || selectedDates.length + opt.extraDays}</div>
                        </div>
                        <div class="gain-item">
                            <div class="gain-label">Jours de repos</div>
                            <div class="gain-value">${(opt.totalDays || selectedDates.length) + opt.gain}</div>
                        </div>
                        <div class="gain-item">
                            <div class="gain-label">Efficacit√©</div>
                            <div class="gain-value">${opt.efficiency || 100}%</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function applyOptimization(index) {
            updateAIMessage(`‚úÖ Optimisation appliqu√©e ! Consultez le calendrier pour voir les modifications.`, 'success');
        }

        // ===== PLANIFICATION ANNUELLE =====
        function suggestBridges() {
            const currentYear = new Date().getFullYear();
            const bridges = [];
            
            JOURS_FERIES_2025.forEach(holiday => {
                const holidayDate = new Date(holiday.date);
                const dayOfWeek = holidayDate.getDay();
                
                if (dayOfWeek === 4) { // Jeudi
                    const friday = new Date(holidayDate);
                    friday.setDate(friday.getDate() + 1);
                    bridges.push({
                        name: holiday.nom,
                        date: holidayDate,
                        suggestion: `Prenez le ${formatDisplayDate(formatDate(holidayDate))} pour avoir 4 jours de repos (jeudi + vendredi + weekend)`,
                        daysNeeded: 1,
                        totalDays: 4
                    });
                } else if (dayOfWeek === 2) { // Mardi
                    const monday = new Date(holidayDate);
                    monday.setDate(monday.getDate() - 1);
                    bridges.push({
                        name: holiday.nom,
                        date: holidayDate,
                        suggestion: `Prenez le ${formatDisplayDate(formatDate(monday))} pour avoir 4 jours de repos (lundi + mardi + weekend)`,
                        daysNeeded: 1,
                        totalDays: 4
                    });
                }
            });
            
            if (bridges.length === 0) {
                updateAIMessage('‚ÑπÔ∏è Aucun pont optimal d√©tect√© pour cette ann√©e. Les jours f√©ri√©s ne tombent pas sur des jeudis ou mardis.', 'info');
                return;
            }
            
            let message = `üåâ <strong>Meilleurs ponts de l'ann√©e ${currentYear} :</strong><br><br>`;
            bridges.forEach((bridge, index) => {
                message += `${index + 1}. <strong>${bridge.name}</strong> (${formatDisplayDate(formatDate(bridge.date))})<br>`;
                message += `   ${bridge.suggestion}<br>`;
                message += `   ‚Üí Gain : ${bridge.totalDays} jours de repos pour ${bridge.daysNeeded} jour de cong√©<br><br>`;
            });
            
            updateAIMessage(message, 'success');
        }

        function suggestSummerPeriod() {
            const today = new Date();
            const currentYear = today.getFullYear();
            
            // Sugg√©rer une p√©riode estivale de 12 jours minimum
            const suggestedStart = new Date(currentYear, 4, 15); // 15 mai
            const suggestedEnd = new Date(currentYear, 4, 26); // 26 mai (12 jours ouvrables)
            
            const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
            const lastOuvrable = getLastOuvrableBefore(new Date(suggestedEnd.getTime() + 86400000), weeklyRestDay);
            const workDays = countOuvrables(suggestedStart, lastOuvrable, weeklyRestDay);
            
            let message = `‚òÄÔ∏è <strong>Suggestion de p√©riode estivale pour le fractionnement :</strong><br><br>`;
            message += `üìÖ <strong>P√©riode recommand√©e :</strong> Du ${formatDisplayDate(formatDate(suggestedStart))} au ${formatDisplayDate(formatDate(suggestedEnd))}<br>`;
            message += `üìä <strong>Jours ouvrables :</strong> ${workDays} jours<br><br>`;
            message += `‚úÖ Cette p√©riode vous permet de :<br>`;
            message += `‚Ä¢ Respecter la condition des 12 jours continus en √©t√© (mai-octobre)<br>`;
            message += `‚Ä¢ √ätre √©ligible au fractionnement si vous gardez 3-6 jours du principal pour l'hiver<br>`;
            message += `‚Ä¢ Profiter d'une belle p√©riode estivale<br><br>`;
            message += `üí° <em>Vous pouvez ajuster cette p√©riode selon vos pr√©f√©rences, l'important est d'avoir au moins 12 jours continus entre le 1er mai et le 31 octobre.</em>`;
            
            updateAIMessage(message, 'success');
            
            addAISuggestion(
                'Appliquer cette suggestion',
                'Je peux s√©lectionner cette p√©riode sur le calendrier pour vous',
                () => {
                    selectedDates = [];
                    let current = new Date(suggestedStart);
                    while (current <= suggestedEnd) {
                        selectedDates.push(formatDate(current));
                        current.setDate(current.getDate() + 1);
                    }
                    renderCalendar();
                    updateSelectionInfo();
                    updateAIMessage('‚úÖ P√©riode estivale sugg√©r√©e s√©lectionn√©e sur le calendrier !', 'success');
                }
            );
        }

        function suggestWinterPeriod() {
            const today = new Date();
            const currentYear = today.getFullYear();
            
            // Sugg√©rer une p√©riode hivernale de 3-6 jours
            const suggestedStart = new Date(currentYear, 11, 23); // 23 d√©cembre
            const suggestedEnd = new Date(currentYear, 11, 27); // 27 d√©cembre
            
            const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
            const lastOuvrable = getLastOuvrableBefore(new Date(suggestedEnd.getTime() + 86400000), weeklyRestDay);
            const workDays = countOuvrables(suggestedStart, lastOuvrable, weeklyRestDay);
            
            let message = `‚ùÑÔ∏è <strong>Suggestion de p√©riode hivernale pour optimiser le fractionnement :</strong><br><br>`;
            message += `üìÖ <strong>P√©riode recommand√©e :</strong> Du ${formatDisplayDate(formatDate(suggestedStart))} au ${formatDisplayDate(formatDate(suggestedEnd))}<br>`;
            message += `üìä <strong>Jours ouvrables :</strong> ${workDays} jours<br><br>`;
            message += `‚úÖ Cette p√©riode vous permet de :<br>`;
            message += `‚Ä¢ Utiliser 3-6 jours du principal en p√©riode hivernale (novembre-avril)<br>`;
            message += `‚Ä¢ Obtenir +2 jours de fractionnement si vous avez 6 jours ou +1 jour si vous avez 3 jours<br>`;
            message += `‚Ä¢ Profiter des f√™tes de fin d'ann√©e<br><br>`;
            message += `üí° <em>L'id√©al est de r√©server 6 jours du principal (sur vos 24) pour l'hiver afin de maximiser le fractionnement.</em>`;
            
            updateAIMessage(message, 'success');
            
            addAISuggestion(
                'Appliquer cette suggestion',
                'Je peux s√©lectionner cette p√©riode sur le calendrier pour vous',
                () => {
                    selectedDates = [];
                    let current = new Date(suggestedStart);
                    while (current <= suggestedEnd) {
                        selectedDates.push(formatDate(current));
                        current.setDate(current.getDate() + 1);
                    }
                    renderCalendar();
                    updateSelectionInfo();
                    updateAIMessage('‚úÖ P√©riode hivernale sugg√©r√©e s√©lectionn√©e sur le calendrier !', 'success');
                }
            );
        }

        function generateYearlyPlan() {
            const annualRights = parseInt(document.getElementById('annualRights').value) || 30;
            const totalDays = currentBalance.principal + currentBalance.cinquieme + 
                            currentBalance.fractionnement + currentBalance.anciennete + 
                            currentBalance.enfant + currentBalance.report;
            
            let message = `üìä <strong>Plan d'optimisation annuel personnalis√© :</strong><br><br>`;
            message += `üìà <strong>Votre situation actuelle :</strong><br>`;
            message += `‚Ä¢ Total de jours disponibles : ${totalDays} jours<br>`;
            message += `‚Ä¢ Principal : ${currentBalance.principal} jours<br>`;
            message += `‚Ä¢ 5√®me semaine : ${currentBalance.cinquieme} jours<br>`;
            message += `‚Ä¢ Fractionnement actuel : ${currentBalance.fractionnement} jours<br><br>`;
            
            message += `üéØ <strong>Strat√©gie recommand√©e :</strong><br>`;
            message += `1. <strong>P√©riode estivale (Mai-Octobre) :</strong><br>`;
            message += `   ‚Üí Prenez au moins 12 jours continus du principal en √©t√©<br>`;
            message += `   ‚Üí Id√©alement 18-20 jours pour profiter pleinement<br><br>`;
            
            message += `2. <strong>P√©riode hivernale (Novembre-Avril) :</strong><br>`;
            message += `   ‚Üí R√©servez 6 jours du principal pour l'hiver<br>`;
            message += `   ‚Üí Cela vous donnera +2 jours de fractionnement<br><br>`;
            
            message += `3. <strong>Optimisation des ponts :</strong><br>`;
            message += `   ‚Üí Utilisez les ponts pour maximiser vos weekends<br>`;
            message += `   ‚Üí 1 jour de cong√© peut donner 4 jours de repos<br><br>`;
            
            const potentialGain = 2; // Fractionnement maximum
            message += `üí∞ <strong>Gain potentiel :</strong> +${potentialGain} jours de fractionnement si vous suivez cette strat√©gie !<br><br>`;
            
            message += `üí° <em>Utilisez les suggestions ci-dessus pour planifier vos p√©riodes sp√©cifiques.</em>`;
            
            updateAIMessage(message, 'success');
            
            // Analyser l'historique existant
            if (leaveHistory.length > 0) {
                let totalTaken = 0;
                let summerTaken = 0;
                let winterTaken = 0;
                
                leaveHistory.forEach(leave => {
                    totalTaken += leave.jours;
                    const start = new Date(leave.debut);
                    const month = start.getMonth();
                    if (month >= 4 && month <= 9) {
                        summerTaken += leave.jours;
                    } else {
                        winterTaken += leave.jours;
                    }
                });
                
                addAISuggestion(
                    'Analyse de votre historique',
                    `Vous avez d√©j√† pris ${totalTaken} jours (${summerTaken} en √©t√©, ${winterTaken} en hiver). Cliquez pour une analyse d√©taill√©e.`,
                    () => analyzeHistory()
                );
            }
        }

        // ===== BALANCE =====
        function calculateBalance() {
            currentBalance = {
                anciennete: parseInt(document.getElementById('anciennete').value) || 0,
                enfant: parseInt(document.getElementById('enfant').value) || 0,
                report: parseInt(document.getElementById('report').value) || 0,
                cinquieme: parseInt(document.getElementById('cinquieme').value) || 6,
                fractionnement: parseInt(document.getElementById('fractionnement').value) || 0,
                principal: 24
            };

            document.getElementById('balancePrincipal').textContent = currentBalance.principal;
            document.getElementById('balanceCinquieme').textContent = currentBalance.cinquieme;
            document.getElementById('balanceFractionnement').textContent = currentBalance.fractionnement;
            document.getElementById('balanceAnciennete').textContent = currentBalance.anciennete;
            document.getElementById('balanceEnfant').textContent = currentBalance.enfant;
            document.getElementById('balanceReport').textContent = currentBalance.report;

            const total = currentBalance.principal + currentBalance.cinquieme + 
                         currentBalance.fractionnement + currentBalance.anciennete + 
                         currentBalance.enfant + currentBalance.report;

            updateAIMessage(`‚úÖ Solde recalcul√© ! Vous avez <strong>${total} jours ouvrables</strong> disponibles au total.`, 'success');
        }

        // ===== SIMULATION =====
        function runSimulation() {
            const startDate = document.getElementById('simStartDate').value;
            const endDate = document.getElementById('simEndDate').value;

            if (!startDate || !endDate) {
                updateAIMessage('‚ùå Veuillez renseigner les dates de d√©but et de fin.', 'error');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (end < start) {
                updateAIMessage('‚ùå La date de fin doit √™tre apr√®s la date de d√©but.', 'error');
                return;
            }

            const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
            const reprise = new Date(end);
            reprise.setDate(reprise.getDate() + 1);
            
            const lastOuvrable = getLastOuvrableBefore(reprise, weeklyRestDay);
            const daysNeeded = countOuvrables(start, lastOuvrable, weeklyRestDay);
            
            const result = imputeDays(currentBalance, daysNeeded);

            let html = `
                <div class="simulation-result">
                    <h4 style="color: var(--vinci-blue); margin-bottom: 15px;">üìä R√©sultat de la Simulation</h4>
                    <div class="result-item">
                        <span><strong>P√©riode :</strong></span>
                        <span>${formatDisplayDate(startDate)} ‚Üí ${formatDisplayDate(endDate)}</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Jours ouvrables :</strong></span>
                        <span>${daysNeeded} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Dernier jour ouvrable :</strong></span>
                        <span>${formatDisplayDate(lastOuvrable.toISOString().split('T')[0])}</span>
                    </div>
                </div>

                <div class="gain-loss">
                    <div class="gain">
                        <div class="gain-label">üéØ Imputation CNETP</div>
                        <div class="gain-value">${result.totalConsumed}j</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">
                            ${Object.entries(result.consumed).filter(([k,v]) => v > 0).map(([k,v]) => `${k}: ${v}j`).join('<br>')}
                        </div>
                    </div>
                    <div class="loss">
                        <div class="loss-label">üìâ Solde apr√®s</div>
                        <div class="loss-value">${Object.values(result.remaining).reduce((a,b) => a+b, 0)}j</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">
                            Principal: ${result.remaining.principal}j<br>
                            5√®me: ${result.remaining.cinquieme}j
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('simulationResult').innerHTML = html;
            updateAIMessage(`‚úÖ Simulation termin√©e ! ${daysNeeded} jours ouvrables seront consomm√©s.`, 'success');
        }

        // ===== HISTORIQUE =====
        function addLeavePeriod() {
            const startDate = document.getElementById('newLeaveStart').value;
            const endDate = document.getElementById('newLeaveEnd').value;
            const manualDays = document.getElementById('newLeaveDays').value;

            if (!startDate || !endDate) {
                updateAIMessage('‚ùå Veuillez renseigner les dates de d√©but et de fin.', 'error');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (end < start) {
                updateAIMessage('‚ùå La date de fin doit √™tre apr√®s la date de d√©but.', 'error');
                return;
            }

            const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
            const reprise = new Date(end);
            reprise.setDate(reprise.getDate() + 1);
            
            const lastOuvrable = getLastOuvrableBefore(reprise, weeklyRestDay);
            const calculatedDays = manualDays ? parseInt(manualDays) : countOuvrables(start, lastOuvrable, weeklyRestDay);

            // G√©n√©rer les dates de la p√©riode
            const dates = [];
            let current = new Date(start);
            while (current <= end) {
                dates.push(formatDate(current));
                current.setDate(current.getDate() + 1);
            }

            leaveHistory.push({
                debut: startDate,
                fin: endDate,
                jours: calculatedDays,
                dates: dates
            });

            renderHistoryTable();
            renderCalendar();
            updateStats();
            
            document.getElementById('newLeaveStart').value = '';
            document.getElementById('newLeaveEnd').value = '';
            document.getElementById('newLeaveDays').value = '';

            updateAIMessage(`‚úÖ P√©riode ajout√©e ! ${calculatedDays} jours ouvrables enregistr√©s.`, 'success');
        }

        function renderHistoryTable() {
            const container = document.getElementById('historyTableContainer');
            
            if (leaveHistory.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--text-light); text-align: center; padding: 20px;">
                        Aucune p√©riode de cong√© enregistr√©e. Ajoutez votre premi√®re p√©riode.
                    </p>
                `;
                document.getElementById('analyzeBtn').style.display = 'none';
                document.getElementById('clearBtn').style.display = 'none';
                document.getElementById('exportBtn').style.display = 'none';
                return;
            }

            let html = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date d√©but</th>
                            <th>Date fin</th>
                            <th>Jours</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            leaveHistory.forEach((leave, index) => {
                html += `
                    <tr>
                        <td>${formatDisplayDate(leave.debut)}</td>
                        <td>${formatDisplayDate(leave.fin)}</td>
                        <td><strong>${leave.jours}</strong> jours</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeLeave(${index})" style="padding: 6px 12px; font-size: 0.85rem;">
                                üóëÔ∏è Supprimer
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            document.getElementById('analyzeBtn').style.display = 'inline-flex';
            document.getElementById('clearBtn').style.display = 'inline-flex';
            document.getElementById('exportBtn').style.display = 'inline-flex';
        }

        function removeLeave(index) {
            leaveHistory.splice(index, 1);
            renderHistoryTable();
            renderCalendar();
            updateStats();
            updateAIMessage('‚úÖ P√©riode supprim√©e de l\'historique.', 'success');
        }

        function clearHistory() {
            if (!confirm('√ätes-vous s√ªr de vouloir effacer tout l\'historique ?')) return;
            
            leaveHistory = [];
            renderHistoryTable();
            renderCalendar();
            updateStats();
            updateAIMessage('‚úÖ Historique effac√©.', 'success');
        }

        function importHistory() {
            const input = document.getElementById('historyInput').value.trim();
            if (!input) {
                updateAIMessage('‚ùå Veuillez coller du JSON valide.', 'error');
                return;
            }

            try {
                const data = JSON.parse(input);
                if (!Array.isArray(data)) {
                    throw new Error('Le JSON doit √™tre un tableau');
                }

                leaveHistory = data.map(item => {
                    const dates = [];
                    let current = new Date(item.debut);
                    const end = new Date(item.fin);
                    while (current <= end) {
                        dates.push(formatDate(current));
                        current.setDate(current.getDate() + 1);
                    }
                    return {
                        ...item,
                        dates: dates
                    };
                });

                renderHistoryTable();
                renderCalendar();
                updateStats();
                updateAIMessage(`‚úÖ ${leaveHistory.length} p√©riode(s) import√©e(s) !`, 'success');
            } catch (e) {
                updateAIMessage(`‚ùå Erreur JSON : ${e.message}`, 'error');
            }
        }

        function exportHistory() {
            const json = JSON.stringify(leaveHistory.map(l => ({
                debut: l.debut,
                fin: l.fin,
                jours: l.jours
            })), null, 2);
            
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'historique-conges.json';
            a.click();
            
            updateAIMessage('‚úÖ Historique export√© en JSON !', 'success');
        }

        function analyzeHistory() {
            if (leaveHistory.length === 0) {
                updateAIMessage('‚ùå Veuillez d\'abord ajouter des p√©riodes √† votre historique.', 'error');
                return;
            }

            let totalDays = 0;
            let summerDays = 0;
            let winterDays = 0;
            let maxContinuous = 0;
            let currentContinuous = 0;
            let continuousSummer = false;

            leaveHistory.forEach(leave => {
                totalDays += leave.jours;
                const start = new Date(leave.debut);
                const month = start.getMonth();
                const jours = leave.jours;

                if (month >= 4 && month <= 9) {
                    summerDays += jours;
                    currentContinuous += jours;
                    if (currentContinuous > maxContinuous) maxContinuous = currentContinuous;
                    if (currentContinuous >= 12) continuousSummer = true;
                } else {
                    winterDays += jours;
                    currentContinuous = 0;
                }
            });

            const annualRights = parseInt(document.getElementById('annualRights').value) || 30;
            const principalRemaining = 24 - (totalDays > 24 ? 24 : totalDays);
            const winterPrincipal = Math.min(winterDays, principalRemaining);

            const fractionnement = calculateFractionnement({
                annualRightsAcquired: annualRights,
                principalDaysTakenSummer: summerDays,
                principalDaysTakenWinter: winterPrincipal,
                isContinuous12Summer: continuousSummer,
                allLeavesInWinter: summerDays === 0 && totalDays > 0
            });

            let analysis = `
                <div class="analysis-box">
                    <h4>üß† Analyse IA de votre historique</h4>
                    <div class="result-item">
                        <span><strong>Total jours pris :</strong></span>
                        <span>${totalDays} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Jours en √©t√© (Mai-Oct) :</strong></span>
                        <span>${summerDays} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Jours en hiver (Nov-Avr) :</strong></span>
                        <span>${winterDays} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Plus longue p√©riode continue en √©t√© :</strong></span>
                        <span>${maxContinuous} jours</span>
                    </div>
                    <div class="result-item">
                        <span><strong>12 jours continus en √©t√© :</strong></span>
                        <span>${continuousSummer ? '‚úÖ Oui' : '‚ùå Non'}</span>
                    </div>
                </div>

                <div class="gain-loss">
                    <div class="gain">
                        <div class="gain-label">üéÅ Fractionnement estim√©</div>
                        <div class="gain-value">+${fractionnement} jour(s)</div>
                    </div>
                    <div class="loss">
                        <div class="loss-label">üìä Solde principal restant</div>
                        <div class="loss-value">${principalRemaining} jours</div>
                    </div>
                </div>

                <div class="tip-box">
                    <strong>üí° Recommandations de l'IA :</strong><br>
            `;

            if (!continuousSummer && summerDays < 12) {
                analysis += `‚ö†Ô∏è Vous n'avez pas pris 12 jours continus en √©t√©. Pour √™tre √©ligible au fractionnement, vous devez prendre au moins 12 jours continus entre le 1er mai et le 31 octobre.<br>`;
            }

            if (winterPrincipal >= 6) {
                analysis += `‚úÖ Excellent ! Vous avez ${winterPrincipal} jours du principal √† prendre en hiver. Cela vous donne droit √† +2 jours de fractionnement !<br>`;
            } else if (winterPrincipal >= 3) {
                analysis += `‚úÖ Bien ! Vous avez ${winterPrincipal} jours du principal √† prendre en hiver. Cela vous donne droit √† +1 jour de fractionnement.<br>`;
            } else {
                analysis += `üí° Pour optimiser, essayez de laisser 3-6 jours du principal (sur les 24) pour la p√©riode hivernale afin d'obtenir le fractionnement.<br>`;
            }

            if (fractionnement === 0 && annualRights >= 15) {
                analysis += `üìå Vous √™tes √©ligible au fractionnement (droits >= 15j) mais vous ne l'obtenez pas encore. Optimisez votre planning !<br>`;
            }

            analysis += `</div>`;

            const container = document.getElementById('historyTableContainer');
            const oldAnalysis = container.querySelector('.analysis-box');
            if (oldAnalysis) {
                oldAnalysis.remove();
            }
            container.insertAdjacentHTML('beforeend', analysis);
            updateAIMessage(`‚úÖ Analyse termin√©e ! ${fractionnement > 0 ? `Vous b√©n√©ficiez de ${fractionnement} jour(s) de fractionnement. üéâ` : 'Optimisez votre planning pour obtenir le fractionnement.'}`, 'success');
        }

        // ===== AUDIT =====
        function runAudit() {
            if (leaveHistory.length === 0) {
                updateAIMessage('‚ùå Veuillez d\'abord ajouter des p√©riodes de cong√© √† votre historique pour l\'audit.', 'error');
                return;
            }

            const container = document.getElementById('auditResults');
            let issues = [];
            let warnings = [];
            let totalCalculated = 0;

            leaveHistory.forEach((leave, index) => {
                const start = new Date(leave.debut);
                const end = new Date(leave.fin);
                const reprise = new Date(end);
                reprise.setDate(reprise.getDate() + 1);
                
                const weeklyRestDay = parseInt(document.getElementById('weeklyRestDay').value) || 0;
                const lastOuvrable = getLastOuvrableBefore(reprise, weeklyRestDay);
                const calculatedDays = countOuvrables(start, lastOuvrable, weeklyRestDay);
                totalCalculated += calculatedDays;

                if (leave.jours) {
                    const diff = Math.abs(calculatedDays - leave.jours);
                    if (diff > 0) {
                        issues.push({
                            period: `${leave.debut} ‚Üí ${leave.fin}`,
                            declared: leave.jours,
                            calculated: calculatedDays,
                            diff: diff
                        });
                    }
                } else {
                    warnings.push({
                        period: `${leave.debut} ‚Üí ${leave.fin}`,
                        calculated: calculatedDays
                    });
                }
            });

            let html = '';

            if (issues.length === 0 && warnings.length === 0) {
                html = `
                    <div class="audit-alert success">
                        <span style="font-size: 1.5rem;">‚úÖ</span>
                        <div>
                            <strong>Audit r√©ussi !</strong><br>
                            Aucune erreur d√©tect√©e dans votre d√©compte. Total calcul√© : ${totalCalculated} jours ouvrables.
                        </div>
                    </div>
                `;
            } else {
                if (issues.length > 0) {
                    html += `
                        <div class="audit-alert error">
                            <span style="font-size: 1.5rem;">‚ùå</span>
                            <div>
                                <strong>${issues.length} erreur(s) d√©tect√©e(s) :</strong><br>
                                <ul style="margin-top: 10px; margin-left: 20px;">
                    `;
                    issues.forEach(issue => {
                        html += `<li>P√©riode ${issue.period} : D√©clar√© ${issue.declared} jours, Calcul√© ${issue.calculated} jours (diff√©rence: ${issue.diff} jour(s))</li>`;
                    });
                    html += `</ul></div></div>`;
                }

                if (warnings.length > 0) {
                    html += `
                        <div class="audit-alert warning">
                            <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                            <div>
                                <strong>${warnings.length} p√©riode(s) sans nombre de jours d√©clar√© :</strong><br>
                                <ul style="margin-top: 10px; margin-left: 20px;">
                    `;
                    warnings.forEach(warning => {
                        html += `<li>P√©riode ${warning.period} : Calcul√© ${warning.calculated} jours ouvrables</li>`;
                    });
                    html += `</ul></div></div>`;
                }
            }

            html += `
                <div class="analysis-box" style="margin-top: 20px;">
                    <h4>üìä R√©sum√© de l'audit</h4>
                    <div class="result-item">
                        <span><strong>Total jours calcul√©s :</strong></span>
                        <span>${totalCalculated} jours ouvrables</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Erreurs d√©tect√©es :</strong></span>
                        <span>${issues.length}</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Avertissements :</strong></span>
                        <span>${warnings.length}</span>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            updateAIMessage(`üîç Audit termin√© ! ${issues.length} erreur(s) d√©tect√©e(s), ${warnings.length} avertissement(s).`, issues.length > 0 ? 'error' : 'warning');
        }

        // ===== UTILITAIRES =====
        function updateStats() {
            const fractionnement = calculateFractionnementFromHistory();
            document.getElementById('fractionnement').value = fractionnement;
            currentBalance.fractionnement = fractionnement;
            
            document.getElementById('balanceFractionnement').textContent = fractionnement;
        }

        function calculateFractionnementFromHistory() {
            if (leaveHistory.length === 0) return 0;

            let summerDays = 0;
            let winterDays = 0;
            let has12ContinuousSummer = false;
            
            leaveHistory.forEach(leave => {
                const start = new Date(leave.debut);
                const month = start.getMonth();
                
                if (month >= 4 && month <= 9) {
                    summerDays += leave.jours;
                    if (leave.jours >= 12) has12ContinuousSummer = true;
                } else {
                    winterDays += leave.jours;
                }
            });

            const annualRights = parseInt(document.getElementById('annualRights').value) || 30;
            
            return calculateFractionnement({
                annualRightsAcquired: annualRights,
                principalDaysTakenSummer: summerDays,
                principalDaysTakenWinter: winterDays,
                isContinuous12Summer: has12ContinuousSummer,
                allLeavesInWinter: summerDays === 0 && winterDays > 0
            });
        }

        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(dateStr) {
            const date = new Date(dateStr);
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
        }

        function isHoliday(dateStr) {
            return JOURS_FERIES_2025.some(h => h.date === dateStr);
        }

        function isWeekend(date) {
            const day = new Date(date).getDay();
            return day === 0 || day === 6;
        }

        function hasLeaveOnDate(dateStr) {
            return leaveHistory.some(leave => leave.dates && leave.dates.includes(dateStr));
        }

        function countWorkDaysFromDates(dates) {
            return dates.filter(date => {
                return !isWeekend(date) && !isHoliday(date);
            }).length;
        }

        // ===== INITIALISATION =====
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            document.getElementById('simStartDate').value = today.toISOString().split('T')[0];
            document.getElementById('simEndDate').value = nextWeek.toISOString().split('T')[0];
            
            calculateBalance();
            renderCalendar();
            
            // Suggestions initiales de l'IA
            setTimeout(() => {
                const totalDays = currentBalance.principal + currentBalance.cinquieme + 
                                currentBalance.fractionnement + currentBalance.anciennete + 
                                currentBalance.enfant + currentBalance.report;
                
                if (leaveHistory.length === 0) {
                    addAISuggestion(
                        'Commencer votre planification',
                        'Je peux vous aider √† planifier vos vacances sur toute l\'ann√©e. Cliquez sur "G√©n√©rer un plan" dans la section Planification Annuelle.',
                        () => generateYearlyPlan()
                    );
                } else {
                    addAISuggestion(
                        'Analyser votre historique',
                        'J\'ai d√©tect√© des p√©riodes enregistr√©es. Je peux analyser votre planification et vous donner des conseils d\'optimisation.',
                        () => analyzeHistory()
                    );
                }
            }, 1000);
        });
    </script>
</body>
</html>